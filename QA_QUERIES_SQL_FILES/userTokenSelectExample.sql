INSERT INTO public."QA_QUERIES_NEW" (name, query)
VALUES ('userTokenSelectExample99', 'BEGIN%3B%0A%0A------------Begin%20raw%20dataset%20of%20DDP%20and%20dedup%20transaction%20within%20same%20date----------------%0Adrop%20table%20if%20exists%20temp_ddp_dedup%3B%0Acreate%20temp%20table%20temp_ddp_dedup%20as%20%0Aselect%20min%28bt.id%29%20as%20id%2Cic.bin%2C%20ic.pcn%2C%20phy.npi%2C%20lower%28trim%28ip.cardholder_id%29%29%20as%20cardholder_id%2C%20pat.birthdate%3A%3Adate%2C%20pm.ndc%2C%20pm.quantity%2C%20pharm.ncpdp_id%2C%20bt.inserted_at%3A%3Adate%0Afrom%20public.beacon_transactions%20bt%0Ajoin%20public.patients%20pat%20on%20bt.patient_id%20%3D%20pat.id%0Ajoin%20public.priced_medications%20pm%20on%20bt.id%20%3D%20pm.beacon_transaction_id%20and%20pm.chosen_med%20%3D%20true%0Ajoin%20public.providers%20phy%20on%20bt.provider_id%20%3D%20phy.id%0Ajoin%20public.organizations%20org%20on%20phy.organization_id%20%3D%20org.id%0Ajoin%20public.insurance_policies%20ip%20on%20pat.id%20%3D%20ip.patient_id%0Ajoin%20public.insurance_companies%09ic%20on%20ip.insurance_company_id%20%3D%20ic.id%0Ajoin%20public.payers%20payer%20on%20ic.payer_id%20%3D%20payer.id%20%0Ajoin%20pbm_logs%20pl%20on%20bt.request_id%20%3D%20pl.request_id%20and%20pl.is_final%20%3D%20true%20%0Aleft%20join%20pharmacies%20pharm%20on%20pm.pharmacy_id%20%3D%20pharm.id%0Awhere%20lower%28payer.%22name%22%29%20%3D%20%27horizon%27%0A%09and%20lower%28bt.transaction_type%29%20%3D%20%27c%27%0A%09and%20org.ehr_organization_id%20not%20in%20%28%271%27%29%0A%09and%20bt.pbm_called%20%3D%20true%20--%20called%20PBM%20for%20info%0A%09and%20bt.inserted_at%3A%3Adate%20between%20cast%28date_trunc%28%27month%27%2C%20current_date%20-%20%274%20month%27%3A%3Ainterval%29%20as%20date%29%20and%20cast%28date_trunc%28%27month%27%2C%20current_date%29-%20%271%20second%27%3A%3Ainterval%20as%20date%29%0A%09and%20bt.inserted_at%3A%3Adate%20%3E%20%272020-09-30%27%0Agroup%20by%20ic.bin%2C%20ic.pcn%2C%20phy.npi%2C%20lower%28trim%28ip.cardholder_id%29%29%2C%20pat.birthdate%3A%3Adate%2C%20pm.ndc%2C%20pm.quantity%2C%20pharm.ncpdp_id%2C%20bt.inserted_at%3A%3Adate%0A%3B%0A%0Acreate%20index%20temp_ddp_dedup_idx1%20on%20temp_ddp_dedup%28id%29%3B%0A%0Adrop%20table%20if%20exists%20temp_ddp%3B%0Acreate%20temp%20table%20temp_ddp%20as%20%0Aselect%20tp.%2A%2C%20lower%28trim%28pat.first_name%29%29%20as%20first_name%2C%20lower%28trim%28pat.last_name%29%29%20as%20last_name%0Afrom%20temp_ddp_dedup%20tp%0Ajoin%20public.beacon_transactions%20bt%20on%20bt.id%20%3D%20tp.id%0Ajoin%20public.patients%20pat%20on%20bt.patient_id%20%3D%20pat.id%0A%3B%0A%0Acreate%20index%20temp_ddp_idx1%20on%20temp_ddp%28id%29%3B%0Acreate%20index%20temp_ddp_idx2%20on%20temp_ddp%28birthdate%2C%20last_name%29%3B%0A%0A--Cleanup%20temp%20data%0Adrop%20table%20if%20exists%20temp_ddp_dedup%3B%0A%0A------------End%20raw%20dataset%20of%20DDP----------------%0A%0A--%20clean%20up%20generic%20drug%20name%20%28remove%20form%20names%29%0Adrop%20table%20if%20exists%20tmp_pe%3B%0Acreate%20temp%20table%20tmp_pe%20as%0Aselect%20%2A%2C%0A%20%20%20%20case%20when%20strpos%28lower%28generic_drug_item_name%29%2C%20%27oral%27%29%20%3E%200%20then%20left%28generic_drug_item_name%2C%20strpos%28lower%28generic_drug_item_name%29%2C%20%27oral%27%29%20-%201%29%0A%20%20%20%20%20%20%20%20%20when%20strpos%28lower%28generic_drug_item_name%29%2C%20%27ophthalmic%27%29%20%3E%200%20then%20left%28generic_drug_item_name%2C%20strpos%28lower%28generic_drug_item_name%29%2C%20%27ophthalmic%27%29%20-%201%29%0A%20%20%20%20%20%20%20%20%20when%20strpos%28lower%28generic_drug_item_name%29%2C%20%27nasal%20spray%27%29%20%3E%200%20then%20left%28generic_drug_item_name%2C%20strpos%28lower%28generic_drug_item_name%29%2C%20%27nasal%20spray%27%29%20-%201%29%0A%20%20%20%20%20%20%20%20%20when%20strpos%28lower%28generic_drug_item_name%29%2C%20%27pressurized%27%29%20%3E%200%20then%20left%28generic_drug_item_name%2C%20strpos%28lower%28generic_drug_item_name%29%2C%20%27pressurized%27%29%20-%201%29%0A%20%20%20%20%20%20%20%20%20when%20strpos%28lower%28generic_drug_item_name%29%2C%20%27respiratory%27%29%20%3E%200%20then%20left%28generic_drug_item_name%2C%20strpos%28lower%28generic_drug_item_name%29%2C%20%27respiratory%27%29%20-%201%29%0A%20%20%20%20%20%20%20%20%20when%20strpos%28lower%28generic_drug_item_name%29%2C%20%27topical%27%29%20%3E%200%20then%20left%28generic_drug_item_name%2C%20strpos%28lower%28generic_drug_item_name%29%2C%20%27topical%27%29%20-%201%29%0A%20%20%20%20%20%20%20%20%20when%20strpos%28lower%28generic_drug_item_name%29%2C%20%27chewable%27%29%20%3E%200%20then%20left%28generic_drug_item_name%2C%20strpos%28lower%28generic_drug_item_name%29%2C%20%27chewable%27%29%20-%201%29%0A%20%20%20%20%20%20%20%20%20when%20strpos%28lower%28generic_drug_item_name%29%2C%20%27powder%27%29%20%3E%200%20then%20left%28generic_drug_item_name%2C%20strpos%28lower%28generic_drug_item_name%29%2C%20%27powder%27%29%20-%201%29%0A%20%20%20%20%20%20%20%20%20when%20strpos%28lower%28generic_drug_item_name%29%2C%20%27nebulizer%27%29%20%3E%200%20then%20left%28generic_drug_item_name%2C%20strpos%28lower%28generic_drug_item_name%29%2C%20%27nebulizer%27%29%20-%201%29%0A%20%20%20%20%20%20%20%20%20when%20strpos%28lower%28generic_drug_item_name%29%2C%20%27transdermal%27%29%20%3E%200%20then%20left%28generic_drug_item_name%2C%20strpos%28lower%28generic_drug_item_name%29%2C%20%27transdermal%27%29%20-%201%29%0A%20%20%20%20%20%20%20%20%20when%20strpos%28lower%28generic_drug_item_name%29%2C%20%27solution%27%29%20%3E%200%20then%20left%28generic_drug_item_name%2C%20strpos%28lower%28generic_drug_item_name%29%2C%20%27solution%27%29%20-%201%29%0A%20%20%20%20%20%20%20%20else%20generic_drug_item_name%20%0A%20%20%20%20end%20as%20generic_drug_name%0Afrom%20product_equivalencies%20pe%3B%0A%0Acreate%20index%20tmp_pe_idx1%20on%20tmp_pe%28specific_product_id%29%3B%0A%0A%0A------------Begin%20MML%20List---------------------%0Adrop%20table%20if%20exists%20temp_mml_patient%3B%0Acreate%20temp%20table%20temp_mml_patient%20as%20%0Aselect%20trim%28cm.patient_first_name%29%20as%20patient_first_name%0A%2Csubstring%28trim%28cm.patient_first_name%29%2C%201%2C%201%29%20as%20patient_first_name_initial%0A%2Ctrim%28cm.patient_last_name%29%20as%20patient_last_name%0A%2Cdate_of_birth%3A%3Adate%0A%2Ctrim%28cm.cardholder_id%29%20as%20cardholder_id%0A%2Clower%28%27hzn%27%7C%7C%20trim%28cm.cardholder_id%29%20%7C%7C%20cm.date_of_birth%3A%3Adate%29%20%20as%20patient_identifier%0A%2Ccm.service_provider_id%0Afrom%20public.horizon_claims%20cm%0Awhere%20%28cm.date_of_service%3A%3Adate%20between%20cast%28date_trunc%28%27month%27%2C%20current_date%20-%20%271%20month%27%3A%3Ainterval%29%20as%20date%29%20and%20cast%28date_trunc%28%27month%27%2C%20current_date%29-%20%271%20second%27%3A%3Ainterval%20as%20date%29%0A%09%09or%20%28cm.inserted_at%3A%3Adate%20between%20cast%28date_trunc%28%27month%27%2C%20current_date%20-%20%271%20month%27%3A%3Ainterval%29%20as%20date%29%20and%20cast%28date_trunc%28%27month%27%2C%20current_date%29-%20%271%20second%27%3A%3Ainterval%20as%20date%29%29%0A%09%20%20%29%0Agroup%20by%20patient_first_name%2Cpatient_first_name_initial%2Cpatient_last_name%2Cdate_of_birth%2Ccardholder_id%2Cpatient_identifier%2Cservice_provider_id%0A%3B%0A%0Acreate%20index%20temp_mml_patient_idx1%20on%20temp_mml_patient%28patient_identifier%29%3B%0A%0A--%20Create%20temp%20table%20for%20MML%20%0Adrop%20table%20if%20exists%20temp_mml%3B%0Acreate%20temp%20table%20temp_mml%0A%28patient_first_name%20varchar%28255%29%2C%0Apatient_first_name_initial%20varchar%28255%29%2C%0Apatient_last_name%20varchar%28255%29%2C%0Adate_of_birth%20date%2C%0Acardholder_id%20varchar%28255%29%2C%0Apatient_identifier%20varchar%28255%29%2C%0Adate_of_service%20date%2C%0Amml_med%20varchar%28255%29%2C%0Amml_med_brand%20varchar%281%29%2C%0Amml_ndc%20varchar%28255%29%2C%0Amml_specific_product_id%20int4%2C%0Amml_gpi_14%20varchar%28255%29%2C%0Amml_gpi_12%20varchar%28255%29%2C%0Amml_gpi_4%20varchar%28255%29%2C%0Amml_quantity%20float8%2C%0Amml_days_supply%20int%2C%0Amml_ncpdp_id%20varchar%28255%29%2C%0Amml_med_type%20varchar%28255%29%2C%0Amml_patient_cost%20float8%2C%0Amml_total_cost%20float8%0A%29%3B%0A%0A--%20insert%20last%20month%20MML%20into%20temp%20table%0Ainsert%20into%20temp_mml%0Aselect%20distinct%20tmpat.patient_first_name%0A%2Ctmpat.patient_first_name_initial%0A%2Ctmpat.patient_last_name%0A%2Ctmpat.date_of_birth%0A%2Ctmpat.cardholder_id%0A%2Clower%28rbch.new_patient_identifier%29%20as%20patient_identifier%0A%2Crbch.date_of_service%0A%2Crbch.med_name%20as%20mml_med%0A%2Crbch.med_brand%0A%2Crbch.med_ndc%0A%2Crbch.specific_product_id%0A%2Cpl.gpi%20as%20mml_gpi_14%20--Claim%20Med%20GPI14%0A%2Csubstring%28pl.gpi%2C1%2C12%29%20as%20mml_gpi_12%20--Claim%20Med%20GPI12%0A%2Csubstring%28pl.gpi%2C1%2C4%29%20as%20mml_gpi_4%20--Claim%20Med%20GPI12%0A%2Crbch.quantity_dispensed%0A%2Crbch.days_supply%0A%2Cpharm.ncpdp_id%0A%2Crbch.med_type%0A%2Crbch.patient_cost%0A%2Crbch.total_cost%0Afrom%20public.rpt_hzn_claim_history%20rbch%0Ajoin%20temp_mml_patient%20tmpat%20on%20lower%28rbch.new_patient_identifier%29%20%3D%20lower%28tmpat.patient_identifier%29%0Ajoin%20public.product_lookup%20pl%20on%20rbch.med_ndc%20%3D%20pl.ndc%0Aleft%20join%20public.pharmacies%20pharm%20on%20tmpat.service_provider_id%20%3D%20pharm.npi%0Awhere%20%28%28rbch.date_of_service%3A%3Adate%20between%20cast%28date_trunc%28%27month%27%2C%20current_date%20-%20%271%20month%27%3A%3Ainterval%29%20as%20date%29%20and%20cast%28date_trunc%28%27month%27%2C%20current_date%29-%20%271%20second%27%3A%3Ainterval%20as%20date%29%29%0A%09%09or%20%28rbch.inserted_at%3A%3Adate%20between%20cast%28date_trunc%28%27month%27%2C%20current_date%20-%20%271%20month%27%3A%3Ainterval%29%20as%20date%29%20and%20cast%28date_trunc%28%27month%27%2C%20current_date%29-%20%271%20second%27%3A%3Ainterval%20as%20date%29%29%0A%09%09%29%0A%3B%0A%0Acreate%20index%20%22_I_temp_mml_patient_identifier%22%20on%20temp_mml%20using%20btree%28patient_identifier%29%3B%0Acreate%20index%20temp_mml_idx1%20on%20temp_mml%28cardholder_id%29%3B%0Acreate%20index%20temp_mml_idx2%20on%20temp_mml%28date_of_birth%29%3B%0Acreate%20index%20temp_mml_idx3%20on%20temp_mml%28patient_last_name%29%3B%0Acreate%20index%20temp_mml_idx4%20on%20temp_mml%28patient_first_name_initial%29%3B%0Acreate%20index%20temp_mml_idx5%20on%20temp_mml%20using%20btree%28patient_identifier%2Cmml_ndc%2Cmml_med%29%3B%0A--create%20index%20temp_mml_idx6%20on%20temp_mml%20using%20btree%28mml_specific_product_id%29%3B%0A------------End%20MML%20List---------------------%0A%0A%0A------------Begin%20Member%20ID%20Matching%20-------------------------%20%0Adrop%20table%20if%20exists%20tmp_match_cardholderid%3B%0Acreate%20temp%20table%20tmp_match_cardholderid%20as%09%0Aselect%20distinct%20a.id%2C%20trim%28cm.cardholder_id%29%20as%20cardholder_id%2C%20lower%28cm.patient_first_name%29%20as%20patient_first_name%0Afrom%20temp_ddp%20a%0Ajoin%20temp_mml%20cm%20on%20a.birthdate%3A%3Adate%20%3D%20cm.date_of_birth%3A%3Adate%0A%09and%20%28%28lower%28a.cardholder_id%29%20%3D%20lower%28cm.cardholder_id%29%20and%20lower%28a.first_name%29%20%3D%20lower%28cm.patient_first_name%29%29%20or%0A%09%09%09%28length%28a.cardholder_id%29%20%3E%2011%20and%20lower%28a.cardholder_id%29%20like%20%27%253hzn%25%27%20and%20%20lower%28SUBSTRING%28a.cardholder_id%2CPOSITION%28%273hzn%27%20IN%20lower%28a.cardholder_id%29%29%2C12%29%29%20%3D%20lower%28SUBSTRING%28cm.cardholder_id%2CPOSITION%28%273hzn%27%20IN%20lower%28cm.cardholder_id%29%29%2C12%29%29%20and%20lower%28a.first_name%29%20%3D%20lower%28cm.patient_first_name%29%29%0A%09%09%29%0A%3B%0A%0Acreate%20index%20tmp_match_cardholderid_idx1%20on%20tmp_match_cardholderid%28id%29%3B%0A%0A------------End%20Member%20ID%20Matching%20-------------------------%20%0A%0A%0A--%20%3Aproduct_type%20%3D%20ddp%0A------------Begin%20Alter%20List----------------%0A--%20Create%20alternative%20list%20temp%20table%0Adrop%20table%20if%20exists%20temp_pre_altermedlist%3B%0Acreate%20temp%20table%20temp_pre_altermedlist%0A%28patient_identifier%20varchar%28255%29%2C%0Areport_created_date%20date%2C%0Abeacon_transaction_id%20int8%2C%0Amed_id%20int8%2C%0Amed_display_name%20varchar%28255%29%2C%0Amed_ndc%20varchar%28255%29%2C%0Amed_brand%20varchar%281%29%2C%0Amed_msc%20varchar%281%29%2C%0Amed_specific_product_id%20int4%2C%0Amed_quantity%20float8%2C%0Amed_days_supply%20int%2C%0Amed_gpi_14%20varchar%28255%29%2C%0Amed_gpi_12%20varchar%28255%29%2C%0Amed_super_concept%20varchar%28255%29%2C%0Amed_patient_pay_amount%20float8%2C%0Amed_total_cost%20float8%2C%0Aalt_id%20int8%2C%0Aalt_display_name%20varchar%28255%29%2C%0Aalt_brand%20varchar%281%29%2C%0Aalt_msc%20varchar%281%29%2C%0Aalt_prior_auth_needed%20varchar%281%29%2C%0Aalt_ndc%20varchar%28255%29%2C%0Aalt_specific_product_id%20int4%2C%0Aalt_med_type%20varchar%28255%29%2C%0Aalt_concept_name%20varchar%28255%29%2C%0Aalt_gpi_14%20varchar%28255%29%2C%0Aalt_gpi_12%20varchar%28255%29%2C%0Aalt_quantity%20float8%2C%0Aalt_days_supply%20int%2C%0Aalt_generic_name%20text%2C%0Aalt_patient_pay_amount%20float8%2C%0Aalt_total_cost%20float8%2C%0Aalt_patient_savings_v1%20float8%2C%0Aalt_total_savings_v1%20float8%0A%29%0A%3B%0A%0Adrop%20table%20if%20exists%20temp_altermedlist%3B%0Acreate%20temp%20table%20temp_altermedlist%0A%28patient_identifier%20varchar%28255%29%2C%0Areport_created_date%20date%2C%0Abeacon_transaction_id%20int8%2C%0Amed_id%20int8%2C%0Amed_display_name%20varchar%28255%29%2C%0Amed_ndc%20varchar%28255%29%2C%0Amed_brand%20varchar%281%29%2C%0Amed_msc%20varchar%281%29%2C%0Amed_specific_product_id%20int4%2C%0Amed_quantity%20float8%2C%0Amed_days_supply%20int%2C%0Amed_gpi_14%20varchar%28255%29%2C%0Amed_gpi_12%20varchar%28255%29%2C%0Amed_super_concept%20varchar%28255%29%2C%0Amed_patient_pay_amount%20float8%2C%0Amed_total_cost%20float8%2C%0Aalt_id%20int8%2C%0Aalt_display_name%20varchar%28255%29%2C%0Aalt_brand%20varchar%281%29%2C%0Aalt_msc%20varchar%281%29%2C%0Aalt_prior_auth_needed%20varchar%281%29%2C%0Aalt_ndc%20varchar%28255%29%2C%0Aalt_specific_product_id%20int4%2C%0Aalt_med_type%20varchar%28255%29%2C%0Aalt_concept_name%20varchar%28255%29%2C%0Aalt_gpi_14%20varchar%28255%29%2C%0Aalt_gpi_12%20varchar%28255%29%2C%0Aalt_quantity%20float8%2C%0Aalt_days_supply%20int%2C%0Aalt_generic_name%20text%2C%0Aalt_patient_pay_amount%20float8%2C%0Aalt_total_cost%20float8%2C%0Aalt_patient_savings_v1%20float8%2C%0Aalt_total_savings_v1%20float8%2C%0Aaltrow%20int4%2C%0Aalt_order%20int4%0A%29%0A%3B%0A%0Adrop%20table%20if%20exists%20tmp_priced_medications%3B%0Acreate%20temp%20table%20tmp_priced_medications%20as%09%0Aselect%20pm.%2A%0Afrom%20temp_ddp%20tp%0Ajoin%20public.priced_medications%20pm%20on%20tp.id%20%3D%20pm.beacon_transaction_id%0A%3B%0Acreate%20index%20tmp_priced_medications_idx1%20on%20tmp_priced_medications%28beacon_transaction_id%2Cchosen_med%2Calternate_pharmacy%2Cehr_presented%29%3B%0Acreate%20index%20tmp_priced_medications_idx2%20on%20tmp_priced_medications%28id%29%3B%0Acreate%20index%20tmp_priced_medications_idx3%20on%20tmp_priced_medications%28ndc%29%3B%0A%0A%0A--%20Insert%20last%204%20month%20alternative%20for%20switch%20analysis%0Ainsert%20into%20temp_pre_altermedlist%0Aselect%20distinct%20%0Acase%20%0A%09when%20tmc.cardholder_id%20is%20not%20null%20then%20lower%28%27hzn%27%20%7C%7C%20trim%28tmc.cardholder_id%29%20%7C%7C%20tp.birthdate%3A%3Adate%29%0A%09else%20%27hznXXX%27%20%7C%7C%20tp.birthdate%3A%3Adate%20%0Aend%20as%20patient_identifier%20--use%20XXX%20to%20avoid%20wrong%20matching%0A%2Ctp.inserted_at%20as%20report_created_date%0A%2Cpm.beacon_transaction_id%20%0A%2Cpm.id%20as%20med_id%0A%2Cpm.%22name%22%20as%20med_display_name%0A%2Cpm.ndc%20as%20med_ndc%0A%2Ccase%0A%09when%20pl.brand%20%3D%20true%20then%20%27Y%27%0A%09when%20pl.brand%20%3D%20false%20then%20%27N%27%0Aend%20as%20med_brand%0A%2Cpl.multi_source_code%20as%20alt_msc%0A%2Cpl.specific_product_id%20as%20med_specific_product_id%0A%2Cpm.quantity%20as%20med_quantity%0A%2Cpm.days_supply%20as%20med_days_supply%0A%2Cpl.gpi%20as%20med_gpi_14%20--Chosen%20Med%20GPI14%0A%2Csubstring%28pl.gpi%2C1%2C12%29%20as%20med_gpi_12%20--Chosen%20Med%20GPI12%0A%2Cpe.super_concept%20as%20med_super_concept%0A%2Cpm.patient_pay_amount%20as%20med_patient_pay_amount%0A%2Cpm.total_cost%20as%20med_total_cost%0A%2Cpm2.id%20as%20alt_id%0A%2Cpm2.%22name%22%20as%20alt_display_name%0A%2Ccase%0A%09when%20pl2.brand%20%3D%20true%20then%20%27Y%27%0A%09when%20pl2.brand%20%3D%20false%20then%20%27N%27%20%0Aend%20as%20alt_brand%0A%2Cpl2.multi_source_code%20as%20alt_msc%0A%2Ccase%20%0A%09when%20pm2.prior_auth_needed%20%3D%20true%20then%20%27Y%27%0A%09when%20pm2.prior_auth_needed%20%3D%20false%20then%20%27N%27%20%0Aend%20as%20alt_prior_auth_needed%0A%2Cpm2.ndc%20as%20alt_ndc%0A%2Cpl2.specific_product_id%20as%20alt_specific_product_id%0A%2C%20case%0A%09when%20pl2.maintenance%20%3D%20true%20then%20%27M%27%09--Maintenance%0A%09when%20pl2.maintenance%20%3D%20false%20and%20pl2.periodic%20%3D%20true%20then%20%27P%27%09--Periodic%0A%09when%20pl2.maintenance%20%3D%20false%20and%20pl2.periodic%20%3D%20false%20then%20%27A%27%09--Acute%0Aend%20as%20alt_med_type%0A%2Cpe2.concept_name%20as%20alt_concept_name%0A%2Cpl2.gpi%20as%20alt_gpi_14%20--Chosen%20Med%20GPI14%0A%2Csubstring%28pl2.gpi%2C1%2C12%29%20as%20alt_gpi_12%20--Chosen%20Med%20GPI12%0A%2Cpm2.quantity%20as%20alt_quantity%0A%2Cpm2.days_supply%20as%20alt_days_supply%0A%2Cpe2.generic_drug_name%20as%20alt_generic_name%0A%2Cpm2.patient_pay_amount%20as%20alt_patient_pay_amount%0A%2Cpm2.total_cost%20as%20alt_total_cost%0A%2Cpm2.patient_savings%20as%20alt_annual_patient_savings_v1%0A%2Cpm2.total_savings%20as%20alt_annual_total_savings_v1%0Afrom%20temp_ddp%20tp%0Ajoin%20tmp_priced_medications%20pm%20on%20tp.id%20%3D%20pm.beacon_transaction_id%20and%20pm.chosen_med%20%3D%20true%0Ajoin%20public.product_lookup%20pl%20on%20pm.ndc%20%3D%20pl.ndc%0Ajoin%20tmp_match_cardholderid%20tmc%20on%20tmc.id%20%3D%20tp.id%0Aleft%20join%20public.product_equivalencies%20pe%20on%20pl.specific_product_id%20%3D%20pe.specific_product_id%0A--left%20join%20public.medication_switch_details%20msd%20on%20pm.id%20%3D%20msd.medication_detail_id%20and%20lower%28msd.product_type%29%20%3D%20%27ddp%27%20and%20reverse_decision%20is%20false%0Aleft%20join%20rpt_ddp_duplicated_medication_list%20rddml%20on%20pm.id%20%3D%20rddml.med_id%0Ajoin%20tmp_priced_medications%20pm2%20on%20tp.id%20%3D%20pm2.beacon_transaction_id%20and%20pm2.chosen_med%20%3D%20false%20and%20pm2.alternate_pharmacy%20%3D%20false%20and%20pm2.ehr_presented%20%3D%20true%0Ajoin%20public.product_lookup%20pl2%20on%20pm2.ndc%20%3Dpl2.ndc%0Aleft%20join%20tmp_pe%20pe2%20on%20pl2.specific_product_id%20%3D%20pe2.specific_product_id%0Awhere%20rddml.med_id%20is%20null%20--%20not%20identified%20as%20dup%20in%20the%20past%0A%3B%0A%0Acreate%20index%20%22_I_temp_pre_altermedlist_med_id%22%20on%20temp_pre_altermedlist%20using%20btree%28med_id%29%0A%3B%0Acreate%20index%20%22_I_temp_pre_altermedlist_patient_identifier_med_id%22%20on%20temp_pre_altermedlist%20using%20btree%28patient_identifier%2Cmed_id%29%0A%3B%0A%0A--Dedup%20the%20same%20existing%20med%20in%20multiple%20months%0Adrop%20table%20if%20exists%20temp_dedup_altermedlist%3B%0Acreate%20temp%20table%20temp_dedup_altermedlist%20as%20%0Aselect%20patient_identifier%2C%20med_ndc%2C%20min%28med_id%29%20as%20med_id%0Afrom%20temp_pre_altermedlist%0Agroup%20by%20patient_identifier%2C%20med_ndc%0A%3B%0Acreate%20index%20%22_I_temp_dedup_altermedlist_patient_identifier%22%20on%20temp_dedup_altermedlist%20using%20btree%28patient_identifier%2Cmed_id%29%0A%3B%0A%0A--%20Table%20storing%20all%20duplicated%20DDP%20in%20medication%20level%0A%0A--Insert%20duplicated%20DDP%20into%20filter%20list%20to%20prevent%20future%20confusion%0Ainsert%20into%20rpt_ddp_duplicated_medication_list%20%28med_id%2Cinserted_at%29%0Aselect%20tpa.med_id%2C%20now%28%29%0Afrom%20temp_pre_altermedlist%20tpa%0Aleft%20join%20temp_dedup_altermedlist%20tda%20on%20tpa.patient_identifier%20%3D%20tda.patient_identifier%20and%20tpa.med_id%20%3D%20tda.med_id%0Awhere%20tda.med_id%20is%20null%0A%3B%0A%0Ainsert%20into%20temp_altermedlist%0Aselect%20tpa.%2A%2Crow_number%28%29%20over%20%28partition%20by%20tpa.beacon_transaction_id%2Ctpa.med_id%2Ctpa.alt_id%20order%20by%20tpa.alt_id%29%20as%20altrow%2Cdense_rank%28%29%20over%20%28partition%20by%20tpa.beacon_transaction_id%20order%20by%20tpa.alt_id%29%20as%20alt_order%0Afrom%20temp_pre_altermedlist%20tpa%0Ajoin%20temp_dedup_altermedlist%20tda%20on%20tpa.patient_identifier%20%3D%20tda.patient_identifier%20and%20tpa.med_ndc%20%3D%20tda.med_ndc%20and%20tpa.med_id%20%3D%20tda.med_id%0Aleft%20join%20rpt_hzn_ddp_claim_gpi_switches%20rhdcgs%20on%20tpa.med_id%20%3D%20rhdcgs.%22ExistingMedInternalID%22%20and%20rhdcgs.%22ReportDate%22%3A%3Adate%20%3E%20%272021-05-21%27%0Awhere%20rhdcgs.%22ExistingMedInternalID%22%20is%20null%0A%3B%0A%0Acreate%20index%20%22_I_temp_altermedlist_patient_identifier%22%20on%20temp_altermedlist%20using%20btree%28patient_identifier%2Creport_created_date%2Cmed_gpi_12%2Calt_gpi_12%29%0A%3B%0Acreate%20index%20%22_I_temp_altermedlist_patient_identifier_2%22%20on%20temp_altermedlist%20using%20btree%28patient_identifier%2Creport_created_date%2Calt_gpi_12%29%0A%3B%0Acreate%20index%20%22_I_temp_altermedlist_patient_identifier_3%22%20on%20temp_altermedlist%20using%20btree%28patient_identifier%2Creport_created_date%2Cmed_gpi_12%2Cmed_super_concept%2Calt_gpi_12%29%0A%3B%0Acreate%20index%20%22_I_temp_altermedlist_patient_identifier_4%22%20on%20temp_altermedlist%20using%20btree%28patient_identifier%2Creport_created_date%2Cmed_super_concept%29%0A%3B%0Acreate%20index%20%22_I_temp_altermedlist_med_id%22%20on%20temp_altermedlist%20using%20btree%28med_id%29%0A%3B%0Acreate%20index%20%22_I_temp_altermedlist_alt_order%22%20on%20temp_altermedlist%20using%20btree%28alt_order%29%0A%3B%0A%0Adrop%20table%20if%20exists%20temp_pre_altermedlist%3B%0Adrop%20table%20if%20exists%20temp_dedup_altermedlist%3B%0A%0Adrop%20table%20if%20exists%20tmp_alter1%3B%0Acreate%20temp%20table%20tmp_alter1%20as%0Aselect%20alt.med_id%2C%20%0A%09alt.alt_display_name%2C%0A%09alt.alt_ndc%2C%0A%09alt.alt_specific_product_id%2C%0A%09alt.alt_concept_name%2C%20%0A%09alt.alt_med_type%2C%20%0A%09alt.alt_patient_savings_v1%2C%20%0A%09alt.alt_total_savings_v1%2C%20%0A%09alt.alt_brand%2C%20%0A%09alt.alt_prior_auth_needed%2C%0A%09alt.alt_quantity%2C%0A%09alt.alt_days_supply%0Afrom%20temp_altermedlist%20alt%0Awhere%20alt.altrow%20%3D%201%20and%20alt.alt_order%20%3D%201%3B%0A%0Adrop%20table%20if%20exists%20tmp_alter2%3B%0Acreate%20temp%20table%20tmp_alter2%20as%0Aselect%20alt.med_id%2C%20%0A%09alt.alt_display_name%2C%0A%09alt.alt_ndc%2C%0A%09alt.alt_specific_product_id%2C%0A%09alt.alt_concept_name%2C%20%0A%09alt.alt_med_type%2C%20%0A%09alt.alt_patient_savings_v1%2C%20%0A%09alt.alt_total_savings_v1%2C%20%0A%09alt.alt_brand%2C%20%0A%09alt.alt_prior_auth_needed%2C%0A%09alt.alt_quantity%2C%0A%09alt.alt_days_supply%0Afrom%20temp_altermedlist%20alt%0Awhere%20alt.altrow%20%3D%201%20and%20alt.alt_order%20%3D%202%3B%0A%0Adrop%20table%20if%20exists%20tmp_alter3%3B%0Acreate%20temp%20table%20tmp_alter3%20as%0Aselect%20alt.med_id%2C%20%0A%09alt.alt_display_name%2C%0A%09alt.alt_ndc%2C%0A%09alt.alt_specific_product_id%2C%0A%09alt.alt_concept_name%2C%20%0A%09alt.alt_med_type%2C%20%0A%09alt.alt_patient_savings_v1%2C%20%0A%09alt.alt_total_savings_v1%2C%20%0A%09alt.alt_brand%2C%20%0A%09alt.alt_prior_auth_needed%2C%0A%09alt.alt_quantity%2C%0A%09alt.alt_days_supply%0Afrom%20temp_altermedlist%20alt%0Awhere%20alt.altrow%20%3D%201%20and%20alt.alt_order%20%3D%203%3B%0A%09%0Acreate%20index%20tmp_alter1_idx1%20on%20tmp_alter1%28med_id%29%3B%0Acreate%20index%20tmp_alter2_idx1%20on%20tmp_alter2%28med_id%29%3B%0Acreate%20index%20tmp_alter3_idx1%20on%20tmp_alter3%28med_id%29%3B%0A%0A------------End%20Alter%20List----------------%0A%0A------------Begin%20Claim%20History%20%20--------------------%0Adrop%20table%20if%20exists%20temp_hzn_claims%3B%0Acreate%20temp%20table%20temp_hzn_claims%20as%0Aselect%20rhch.%2A%2Csubstring%28rhch.gpi_14%2C1%2C12%29%20as%20gpi_12%2Cpe.concept_name%0A%2Cpl.multi_source_code%20as%20med_msc%0A%2Cpe.super_concept%20as%20med_super_concept%0Afrom%20public.rpt_hzn_claim_history%20rhch%0Ajoin%20public.product_lookup%20pl%20on%20rhch.med_ndc%20%3D%20pl.ndc%0Aleft%20join%20tmp_pe%20pe%20on%20pl.specific_product_id%20%3D%20pe.specific_product_id%0Awhere%20rhch.date_of_service%20between%20cast%28date_trunc%28%27month%27%2C%20current_date%20-%20%2716%20month%27%3A%3Ainterval%29%20as%20date%29%20and%20cast%28date_trunc%28%27month%27%2C%20current_date%29-%20%271%20second%27%3A%3Ainterval%20as%20date%29%0A%09and%20rhch.is_late_reversal%20%3D%20false%0A%3B%0A%0Acreate%20index%20%22_I_temp_hzn_claims_patient_identifier_gpi12%22%20on%20temp_hzn_claims%20using%20btree%28new_patient_identifier%2Cgpi_12%29%0A%3B%0Acreate%20index%20%22_I_temp_hzn_claims_patient_identifier_dos_gpi12%22%20on%20temp_hzn_claims%20using%20btree%28new_patient_identifier%2Cdate_of_service%2Cgpi_12%29%0A%3B%0Acreate%20index%20%22_I_temp_hzn_claims_patient_identifier_dos_gpi4%22%20on%20temp_hzn_claims%20using%20btree%28new_patient_identifier%2Cdate_of_service%2Cmed_super_concept%2Cgpi_12%29%0A%3B%0A-----------%20End%20Claim%20History%20---------------------%0A%0A------------Begin%20Reporting-------------%0A---------------Begin%20Tier%201%20------------------------------------------------%0A--%20Key%20for%20Bucket-Matched%20to%20an%20Alternative%20by%20SPID%20brand%20to%20generic%20%0Adrop%20table%20if%20exists%20temp_tier1_prematches%3B%0Acreate%20temp%20table%20temp_tier1_prematches%20as%0Aselect%20distinct%20alt.med_id%0A%09%2Calt.alt_display_name%20as%20alt_med%0A%09%2Calt.alt_brand%0A%09%2Calt.alt_prior_auth_needed%20%20as%20alt_pa%0A%09%2Calt.alt_ndc%0A%09%2Calt.alt_specific_product_id%20as%20alt_spid%0A%09%2Calt.alt_med_type%0A%09%2Calt.alt_concept_name%20as%20alt_concept%0A%09%2Ccase%20%0A%09%09when%20alt.med_patient_pay_amount%20is%20null%20then%20-0.01%0A%09%09when%20lower%28thlmc.med_type%29%20%3D%20%27m%27%20then%20%28%28%28alt.med_patient_pay_amount%2Falt.med_days_supply%29%2A365%29-%28%28thlmc.patient_cost%2Fthlmc.days_supply%29%2A365%29%29%0A%09%09when%20lower%28thlmc.med_type%29%20%3D%20%27p%27%20then%20%28%28%28alt.med_patient_pay_amount%2Falt.med_days_supply%29%2A135%29-%28%28thlmc.patient_cost%2Fthlmc.days_supply%29%2A135%29%29%0A%09%09else%20%28alt.med_patient_pay_amount-thlmc.patient_cost%29%0A%09end%20as%20alt_annual_patient_savings%20%0A%09%2Ccase%0A%09%09when%20alt.med_total_cost%20is%20null%20then%20-0.01%0A%09%09when%20lower%28thlmc.med_type%29%20%3D%20%27m%27%20and%20%28%28%28alt.med_total_cost%2Falt.med_days_supply%29-%28thlmc.total_cost%2Fthlmc.days_supply%29%29%20%3E%3D%20%28-250%3A%3Afloat8%2Fthlmc.days_supply%29%29%20then%20%28%28%28alt.med_total_cost%2Falt.med_days_supply%29%2A365%29-%28%28thlmc.total_cost%2Fthlmc.days_supply%29%2A365%29%29%0A%09%09when%20lower%28thlmc.med_type%29%20%3D%20%27p%27%20and%20%28%28%28alt.med_total_cost%2Falt.med_days_supply%29-%28thlmc.total_cost%2Fthlmc.days_supply%29%29%20%3E%3D%20%28-250%3A%3Afloat8%2Fthlmc.days_supply%29%29%20then%20%28%28%28alt.med_total_cost%2Falt.med_days_supply%29%2A135%29-%28%28thlmc.total_cost%2Fthlmc.days_supply%29%2A135%29%29%0A%09%09when%20lower%28thlmc.med_type%29%20%3D%20%27a%27%20and%20%28%28alt.med_total_cost-thlmc.total_cost%29%20%3E%3D%20-250%3A%3Afloat8%29%20then%20%28alt.med_total_cost-thlmc.total_cost%29%0A%09%09when%20lower%28thlmc.med_type%29%20%3D%20%27m%27%20and%20%28%28%28alt.med_total_cost%2Falt.med_days_supply%29-%28thlmc.total_cost%2Fthlmc.days_supply%29%29%20%3C%20%28-250%3A%3Afloat8%2Fthlmc.days_supply%29%29%20then%20%28%28-250%3A%3Afloat8%2Fthlmc.days_supply%29%2A365%29%0A%09%09when%20lower%28thlmc.med_type%29%20%3D%20%27p%27%20and%20%28%28%28alt.med_total_cost%2Falt.med_days_supply%29-%28thlmc.total_cost%2Fthlmc.days_supply%29%29%20%3C%20%28-250%3A%3Afloat8%2Fthlmc.days_supply%29%29%20then%20%28%28-250%3A%3Afloat8%2Fthlmc.days_supply%29%2A135%29%0A%09%09when%20lower%28thlmc.med_type%29%20%3D%20%27a%27%20and%20%28%28alt.med_total_cost-thlmc.total_cost%29%20%3C%20-250%3A%3Afloat8%29%20then%20-250%3A%3Afloat8%0A%09end%20as%20alt_annual_total_savings%20%0A%09%2Calt.alt_quantity%0A%09%2Calt.alt_days_supply%0A%09%2Calt.alt_order%0A%09%2Cthlmc.id%20as%20mml_record_id%0A%09%2Cthlmc.med_name%20as%20mml_med%20%0A%09%2Cthlmc.med_brand%20as%20mml_med_brand%20%0A%09%2Cthlmc.date_of_service%3A%3Adate%20as%20mml_claim_date%0A%09%2Cthlmc.med_ndc%20as%20mml_ndc%20%0A%09%2Cthlmc.specific_product_id%20as%20mml_spid%0A%09%2Cthlmc.concept_name%20as%20mml_concept_name%0A%09%2Cthlmc.quantity_dispensed%20as%20mml_quantity%0A%09%2Cthlmc.days_supply%20as%20mml_days_supply%0A%09%2Cthlmc.med_type%20as%20mml_med_type%0A%09%2Cdate_part%28%27year%27%2Cthlmc.date_of_service%29%3A%3Atext%20%7C%7C%20LPAD%28date_part%28%27month%27%2Cthlmc.date_of_service%29%3A%3Atext%2C%202%2C%20%270%27%29%20as%20switch_change_month%0A%09%2C%27Tier%201%27%20as%20change_type%0A%09%2Cthlmc.patient_cost%20as%20mml_patient_cost%0A%09%2Cthlmc.total_cost%20as%20mml_total_cost%0A%09%2Cthlmc.gpi_14%20as%20mml_gpi%0A%09%2Cthlmc.carrier_id%0A%09%2Cthlmc.account_id%0A%09%2Cthlmc.group_id%0A%09%2Calt.alt_patient_savings_v1%0A%09%2Calt.alt_total_savings_v1%0A%09%2Cthc.new_patient_identifier%0A%09%2Calt.report_created_date%3A%3Adate-thc.date_of_service%3A%3Adate%20as%20lookback_days%0A%09%2Cthlmc.med_super_concept%20as%20mml_med_super_concept%0Afrom%20temp_altermedlist%20alt%0Ajoin%20temp_hzn_claims%20thlmc%20on%20alt.patient_identifier%20%3D%20thlmc.new_patient_identifier%20%0A%09and%20thlmc.date_of_service%3A%3Adate%20%3E%20alt.report_created_date%3A%3Adate%20%0A%09and%20%28%20alt.med_gpi_12%20is%20not%20null%20%0A%09%09%09and%20thlmc.gpi_12%20is%20not%20null%0A%09%09%09and%20%28alt.med_gpi_12%20%3C%3E%20thlmc.gpi_12%0A%09%09%09%09%09or%20%28alt.med_gpi_12%20%3D%20thlmc.gpi_12%20and%20%0A%09%09%09%09%09%09%09%28%28upper%28alt.med_msc%29%20%3D%20%27M%27%20and%20upper%28thlmc.med_msc%29%20in%20%28%27N%27%2C%27O%27%2C%27Y%27%29%29%0A%09%09%09%09%09%09%09or%20%28upper%28alt.med_msc%29%20%3D%20%27N%27%20and%20upper%28thlmc.med_msc%29%20in%20%28%27M%27%2C%27O%27%2C%27Y%27%29%29%0A%09%09%09%09%09%09%09or%20%28upper%28alt.med_msc%29%20%3D%20%27O%27%20and%20upper%28thlmc.med_msc%29%20in%20%28%27N%27%2C%27M%27%29%29%0A%09%09%09%09%09%09%09or%20%28upper%28alt.med_msc%29%20%3D%20%27Y%27%20and%20upper%28thlmc.med_msc%29%20in%20%28%27N%27%2C%27M%27%29%29%29%0A%09%09%09%09%09%09%29%20--%20Existing%20Medication%20%26%20Resulting%20Medication%20with%20same%20GPI-12s%20%0A%09%09%09%09%29%0A%09%09%09and%20trim%28lower%28alt.med_display_name%29%29%20%3C%3E%20trim%28lower%28thlmc.med_name%29%29%0A%09%09%29%0A%09and%20%28alt.alt_gpi_12%20is%20not%20null%20%0A%09%09%09and%20thlmc.gpi_12%20is%20not%20null%20%0A%09%09%09and%20alt.alt_gpi_12%20%3D%20thlmc.gpi_12%29%20--Only%20match%20alternative%20with%20GPI12%0Aleft%20join%20temp_hzn_claims%20thc%20on%20alt.patient_identifier%20%3D%20thc.new_patient_identifier%20%0A%20%20%20%20and%20thc.date_of_service%3A%3Adate%20%3C%3D%20alt.report_created_date%3A%3Adate%0A%09and%20%28%20thlmc.gpi_12%20is%20not%20null%20%0A%09%09%09and%20thc.gpi_12%20is%20not%20null%20%0A%09%09%09and%20thlmc.gpi_12%20%3D%20thc.gpi_12%0A%09%09%09and%20upper%28thlmc.med_msc%29%20%3D%20upper%28thc.med_msc%29%0A%09%09%09and%20trim%28lower%28alt.med_display_name%29%29%20%3C%3E%20trim%28lower%28thc.med_name%29%29%0A%09%09%29%20--resulting%20medication%20was%20not%20filled%20in%20the%20past%20120%0Awhere%20%28%28thlmc.date_of_service%3A%3Adate%20between%20cast%28date_trunc%28%27month%27%2C%20current_date%20-%20%271%20month%27%3A%3Ainterval%29%20as%20date%29%20and%20cast%28date_trunc%28%27month%27%2C%20current_date%29-%20%271%20second%27%3A%3Ainterval%20as%20date%29%29%20--Only%20claims%20for%20previous%20month%0A%09%09%09or%20%28thlmc.inserted_at%3A%3Adate%20between%20cast%28date_trunc%28%27month%27%2C%20current_date%20-%20%271%20month%27%3A%3Ainterval%29%20as%20date%29%20and%20cast%28date_trunc%28%27month%27%2C%20current_date%29-%20%271%20second%27%3A%3Ainterval%20as%20date%29%29%0A%09%09%29%0A%3B%0A%0Adrop%20table%20if%20exists%20temp_tier1_matches%3B%0Acreate%20temp%20table%20temp_tier1_matches%20as%0Aselect%20distinct%20ttp.med_id%0A%09%2Cttp.alt_med%0A%09%2Cttp.alt_brand%0A%09%2Cttp.alt_pa%0A%09%2Cttp.alt_ndc%0A%09%2Cttp.alt_spid%0A%09%2Cttp.alt_med_type%0A%09%2Cttp.alt_concept%09%0A%09%2Cttp.alt_annual_patient_savings%20%0A%09%2Cttp.alt_annual_total_savings%20%0A%09%2Cttp.alt_quantity%0A%09%2Cttp.alt_days_supply%0A%09%2Cttp.alt_order%0A%09%2Cttp.mml_record_id%0A%09%2Cttp.mml_med%20%0A%09%2Cttp.mml_med_brand%20%0A%09%2Cttp.mml_claim_date%0A%09%2Cttp.mml_ndc%20%0A%09%2Cttp.mml_spid%0A%09%2Cttp.mml_concept_name%0A%09%2Cttp.mml_quantity%0A%09%2Cttp.mml_days_supply%0A%09%2Cttp.mml_med_type%0A%09%2Cttp.switch_change_month%0A%09%2Cttp.change_type%0A%09%2Cttp.mml_patient_cost%0A%09%2Cttp.mml_total_cost%0A%09%2Cttp.mml_gpi%0A%09%2Cttp.carrier_id%0A%09%2Cttp.account_id%0A%09%2Cttp.group_id%0A%09%2Cttp.alt_patient_savings_v1%0A%09%2Cttp.alt_total_savings_v1%0A%09%2Cttp.mml_med_super_concept%0Afrom%20temp_tier1_prematches%20ttp%0Aleft%20join%20temp_tier1_prematches%20ttpf%20on%20ttp.med_id%20%3D%20ttpf.med_id%20and%20ttpf.lookback_days%20%3C%20120%0Awhere%20ttp.new_patient_identifier%20is%20null%20or%20ttpf.med_id%20is%20null%0A%3B%0A---------------End%20%20Tier%201%20------------------------------------------------%0A%0A---------------Begin%20Tier%202%20------------------------------------------------%0A--%20Key%20for%20Bucket-Matched%20to%20an%20Alternative%20by%20SPID%20brand%20to%20generic%20%0Adrop%20table%20if%20exists%20temp_tier2_prematches%3B%0Acreate%20temp%20table%20temp_tier2_prematches%20as%0Aselect%20distinct%20alt.med_id%0A%09%2Cnull%20as%20alt_med%0A%09%2Cnull%20as%20alt_brand%0A%09%2Cnull%20as%20alt_pa%0A%09%2Cnull%20as%20alt_ndc%0A%09%2C0%20as%20alt_spid%0A%09%2Cnull%20as%20alt_med_type%0A%09%2Cnull%20as%20alt_concept%09%0A%09%2Ccase%20%0A%09%09when%20alt.med_patient_pay_amount%20is%20null%20then%20-0.01%0A%09%09when%20lower%28thlmc.med_type%29%20%3D%20%27m%27%20then%20%28%28%28alt.med_patient_pay_amount%2Falt.med_days_supply%29%2A365%29-%28%28thlmc.patient_cost%2Fthlmc.days_supply%29%2A365%29%29%0A%09%09when%20lower%28thlmc.med_type%29%20%3D%20%27p%27%20then%20%28%28%28alt.med_patient_pay_amount%2Falt.med_days_supply%29%2A135%29-%28%28thlmc.patient_cost%2Fthlmc.days_supply%29%2A135%29%29%0A%09%09else%20%28alt.med_patient_pay_amount-thlmc.patient_cost%29%0A%09end%20as%20alt_annual_patient_savings%20%0A%09%2Ccase%20%0A%09%09when%20alt.med_total_cost%20is%20null%20then%20-0.01%0A%09%09when%20lower%28thlmc.med_type%29%20%3D%20%27m%27%20then%20%28%28%28alt.med_total_cost%2Falt.med_days_supply%29%2A365%29-%28%28thlmc.total_cost%2Fthlmc.days_supply%29%2A365%29%29%0A%09%09when%20lower%28thlmc.med_type%29%20%3D%20%27p%27%20then%20%28%28%28alt.med_total_cost%2Falt.med_days_supply%29%2A135%29-%28%28thlmc.total_cost%2Fthlmc.days_supply%29%2A135%29%29%0A%09%09else%20%28alt.med_total_cost-thlmc.total_cost%29%0A%09end%20as%20alt_annual_total_savings%20%0A%09%2C0%20as%20alt_quantity%0A%09%2C0%20as%20alt_days_supply%0A%09%2C4%3A%3Aint%20as%20alt_order%0A%09%2Cthlmc.id%20as%20mml_record_id%0A%09%2Cthlmc.med_name%20as%20mml_med%20%0A%09%2Cthlmc.med_brand%20as%20mml_med_brand%20%0A%09%2Cthlmc.date_of_service%3A%3Adate%20as%20mml_claim_date%0A%09%2Cthlmc.med_ndc%20as%20mml_ndc%20%0A%09%2Cthlmc.specific_product_id%20as%20mml_spid%0A%09%2Cthlmc.concept_name%20as%20mml_concept_name%0A%09%2Cthlmc.quantity_dispensed%20as%20mml_quantity%0A%09%2Cthlmc.days_supply%20as%20mml_days_supply%0A%09%2Cthlmc.med_type%20as%20mml_med_type%0A%09%2Cdate_part%28%27year%27%2Cthlmc.date_of_service%29%3A%3Atext%20%7C%7C%20LPAD%28date_part%28%27month%27%2Cthlmc.date_of_service%29%3A%3Atext%2C%202%2C%20%270%27%29%20as%20switch_change_month%0A%09%2C%27Tier%202%27%20as%20change_type%0A%09%2Cthlmc.patient_cost%20as%20mml_patient_cost%0A%09%2Cthlmc.total_cost%20as%20mml_total_cost%0A%09%2Cthlmc.gpi_14%20as%20mml_gpi%0A%09%2Cthlmc.carrier_id%0A%09%2Cthlmc.account_id%0A%09%2Cthlmc.group_id%0A%09%2C250%20as%20alt_patient_savings_v1%0A%09%2C900%20as%20alt_total_savings_v1%0A%09%2Cthc.new_patient_identifier%0A%09%2Calt.report_created_date%3A%3Adate-thc.date_of_service%3A%3Adate%20as%20lookback_days%0A%09%2Cthlmc.med_super_concept%20as%20mml_med_super_concept%0Afrom%20temp_altermedlist%20alt%0Ajoin%20temp_hzn_claims%20thlmc%20on%20alt.patient_identifier%20%3D%20thlmc.new_patient_identifier%20%0A%09and%20thlmc.date_of_service%3A%3Adate%20%3E%20alt.report_created_date%3A%3Adate%20%0A%09and%20%28%20alt.med_gpi_12%20is%20not%20null%20%0A%09%09%09and%20thlmc.gpi_12%20is%20not%20null%20%0A%09%09%09and%20alt.med_gpi_12%20%3C%3E%20thlmc.gpi_12%0A%09%09%09and%20trim%28lower%28alt.med_display_name%29%29%20%3C%3E%20trim%28lower%28thlmc.med_name%29%29%0A%09%09%29%0A%09and%20%28alt.med_super_concept%20is%20not%20null%0A%09%09%09and%20thlmc.med_super_concept%20is%20not%20null%0A%09%09%09and%20upper%28alt.med_super_concept%29%20%3D%20upper%28thlmc.med_super_concept%29%29%20--Super%20Concept%20match%20between%20Existing%20and%20Claim%20Med%20%28resulting%20med%29%0Aleft%20join%20temp_hzn_claims%20thc%20on%20alt.patient_identifier%20%3D%20thc.new_patient_identifier%20%0A%09and%20thc.date_of_service%3A%3Adate%20%3C%3D%20alt.report_created_date%3A%3Adate%20%0A%09and%20%28%20thlmc.gpi_12%20is%20not%20null%20%0A%09%09%09and%20thc.gpi_12%20is%20not%20null%20%0A%09%09%09and%20thlmc.gpi_12%20%3D%20thc.gpi_12%20%0A%09%09%09and%20upper%28thlmc.med_super_concept%29%20%3D%20upper%28thc.med_super_concept%29%0A%09%09%09and%20trim%28lower%28alt.med_display_name%29%29%20%3C%3E%20trim%28lower%28thc.med_name%29%29%0A%09%09%29--resulting%20medication%20was%20not%20filled%20in%20the%20past%20120%09%0Awhere%20%28%28thlmc.date_of_service%3A%3Adate%20between%20cast%28date_trunc%28%27month%27%2C%20current_date%20-%20%271%20month%27%3A%3Ainterval%29%20as%20date%29%20and%20cast%28date_trunc%28%27month%27%2C%20current_date%29-%20%271%20second%27%3A%3Ainterval%20as%20date%29%29%20--Only%20claims%20for%20previous%20month%0A%09%09%09or%20%28thlmc.inserted_at%3A%3Adate%20between%20cast%28date_trunc%28%27month%27%2C%20current_date%20-%20%271%20month%27%3A%3Ainterval%29%20as%20date%29%20and%20cast%28date_trunc%28%27month%27%2C%20current_date%29-%20%271%20second%27%3A%3Ainterval%20as%20date%29%29%0A%09%09%29%0A%3B%0A%0Adrop%20table%20if%20exists%20temp_tier2_matches%3B%0Acreate%20temp%20table%20temp_tier2_matches%20as%0Aselect%20distinct%20ttp.med_id%0A%09%2Cttp.alt_med%0A%09%2Cttp.alt_brand%0A%09%2Cttp.alt_pa%0A%09%2Cttp.alt_ndc%0A%09%2Cttp.alt_spid%0A%09%2Cttp.alt_med_type%0A%09%2Cttp.alt_concept%09%0A%09%2Cttp.alt_annual_patient_savings%20%0A%09%2Cttp.alt_annual_total_savings%20%0A%09%2Cttp.alt_quantity%0A%09%2Cttp.alt_days_supply%0A%09%2Cttp.alt_order%0A%09%2Cttp.mml_record_id%0A%09%2Cttp.mml_med%20%0A%09%2Cttp.mml_med_brand%20%0A%09%2Cttp.mml_claim_date%0A%09%2Cttp.mml_ndc%20%0A%09%2Cttp.mml_spid%0A%09%2Cttp.mml_concept_name%0A%09%2Cttp.mml_quantity%0A%09%2Cttp.mml_days_supply%0A%09%2Cttp.mml_med_type%0A%09%2Cttp.switch_change_month%0A%09%2Cttp.change_type%0A%09%2Cttp.mml_patient_cost%0A%09%2Cttp.mml_total_cost%0A%09%2Cttp.mml_gpi%0A%09%2Cttp.carrier_id%0A%09%2Cttp.account_id%0A%09%2Cttp.group_id%0A%09%2Cttp.alt_patient_savings_v1%0A%09%2Cttp.alt_total_savings_v1%0A%09%2Cttp.mml_med_super_concept%0Afrom%20temp_tier2_prematches%20ttp%0Aleft%20join%20temp_tier2_prematches%20ttpf%20on%20ttp.med_id%20%3D%20ttpf.med_id%20and%20ttpf.lookback_days%20%3C%20120%0Awhere%20ttp.alt_annual_total_savings%20%3E%3D%200%20and%20%28ttp.new_patient_identifier%20is%20null%20or%20ttpf.med_id%20is%20null%29%0A%3B%0A---------------End%20%20Tier%202%20------------------------------------------------%0A%0A%0A------------Begin%20DDP%20with%20existing%20medication%20claim%20%2F%20No%20Switch------------------------------------------------%0Adrop%20table%20if%20exists%20temp_hzn_existing_med_found_list%3B%0Acreate%20temp%20table%20temp_hzn_existing_med_found_list%20as%0Aselect%20distinct%20alt.med_id%0A%09%2Cnull%20as%20alt_med%0A%09%2Cnull%20as%20alt_brand%0A%09%2Cnull%20as%20alt_pa%0A%09%2Cnull%20as%20alt_ndc%0A%09%2C0%20as%20alt_spid%0A%09%2Cnull%20as%20alt_med_type%0A%09%2Cnull%20as%20alt_concept%0A%09%2C0%20as%20alt_annual_patient_savings%20%0A%09%2C0%20as%20alt_annual_total_savings%20%0A%09%2C0%20as%20alt_quantity%0A%09%2C0%20as%20alt_days_supply%0A%09%2C4%3A%3Aint%20as%20alt_order%0A%09--%2Cnull%20as%20most_savings_order%0A%09%2Cthlmc.id%20as%20mml_record_id%0A%09%2Cthlmc.med_name%20as%20mml_med%20%0A%09%2Cthlmc.med_brand%20as%20mml_med_brand%20%0A%09%2Cthlmc.date_of_service%3A%3Adate%20as%20mml_claim_date%0A%09%2Cthlmc.med_ndc%20as%20mml_ndc%20%0A%09%2Cthlmc.specific_product_id%20as%20mml_spid%0A%09%2Cthlmc.concept_name%20as%20mml_concept_name%0A%09%2Cthlmc.quantity_dispensed%20as%20mml_quantity%0A%09%2Cthlmc.days_supply%20as%20mml_days_supply%0A%09%2Cthlmc.med_type%20as%20mml_med_type%0A%09%2Cdate_part%28%27year%27%2Cthlmc.date_of_service%29%3A%3Atext%20%7C%7C%20LPAD%28date_part%28%27month%27%2Cthlmc.date_of_service%29%3A%3Atext%2C%202%2C%20%270%27%29%20as%20switch_change_month%0A%09%2C%27Existing%20Medication%20Found%27%20as%20change_type%0A%09%2Cthlmc.patient_cost%20as%20mml_patient_cost%0A%09%2Cthlmc.total_cost%20as%20mml_total_cost%0A%09%2Cthlmc.gpi_14%20as%20mml_gpi%0A%09%2Cthlmc.carrier_id%0A%09%2Cthlmc.account_id%0A%09%2Cthlmc.group_id%0A%09%2C0%20as%20alt_patient_savings_v1%0A%09%2C0%20as%20alt_total_savings_v1%0A%09%2Cthlmc.med_super_concept%20as%20mml_med_super_concept%0Afrom%20temp_altermedlist%20alt%0Ajoin%20temp_hzn_claims%20thlmc%20on%20alt.patient_identifier%20%3D%20thlmc.new_patient_identifier%20--%20Claim%20%231%0A%09and%20thlmc.date_of_service%3A%3Adate%20%3E%20alt.report_created_date%3A%3Adate%20%0A%09and%20%28%0A%09%09%09%28alt.med_gpi_12%20is%20not%20null%20%0A%09%09%09%09and%20thlmc.gpi_12%20is%20not%20null%0A%09%09%09%09and%20%28alt.med_gpi_12%20%3D%20thlmc.gpi_12%20%0A%09%09%09%09%09%09%09and%20%28%28upper%28alt.med_msc%29%20%3D%20%27N%27%20and%20upper%28thlmc.med_msc%29%20%3D%20%27N%27%29%0A%09%09%09%09%09%09%09%09or%20%28upper%28alt.med_msc%29%20%3D%20%27M%27%20and%20upper%28thlmc.med_msc%29%20%3D%20%27M%27%29%0A%09%09%09%09%09%09%09%09or%20%28upper%28alt.med_msc%29%20%3D%20%27O%27%20and%20upper%28thlmc.med_msc%29%20in%20%28%27O%27%2C%27Y%27%29%29%0A%09%09%09%09%09%09%09%09or%20%28upper%28alt.med_msc%29%20%3D%20%27Y%27%20and%20upper%28thlmc.med_msc%29%20in%20%28%27O%27%2C%27Y%27%29%29%29%0A%09%09%09%09%09%29%20--%20Existing%20Medication%20%26%20Resulting%20Medication%20with%20same%20GPI-12s%20%0A%09%09%09%29%0A%09%09%09or%20trim%28lower%28alt.med_display_name%29%29%20%3D%20trim%28lower%28thlmc.med_name%29%29%20--%20Existing%20Medication%20%26%20Resulting%20Medication%20with%20same%20med%20name%20%0A%09%09%29%0Awhere%20%28%28thlmc.date_of_service%3A%3Adate%20between%20cast%28date_trunc%28%27month%27%2C%20current_date%20-%20%271%20month%27%3A%3Ainterval%29%20as%20date%29%20and%20cast%28date_trunc%28%27month%27%2C%20current_date%29-%20%271%20second%27%3A%3Ainterval%20as%20date%29%29%20--Only%20claims%20for%20previous%20month%0A%09%09%09or%20%28thlmc.inserted_at%3A%3Adate%20between%20cast%28date_trunc%28%27month%27%2C%20current_date%20-%20%271%20month%27%3A%3Ainterval%29%20as%20date%29%20and%20cast%28date_trunc%28%27month%27%2C%20current_date%29-%20%271%20second%27%3A%3Ainterval%20as%20date%29%29%0A%09%09%29%0A%3B%0A%0Acreate%20index%20%22_I_temp_hzn_existing_med_found_list_med_id_most_savings_order%22%20on%20temp_hzn_existing_med_found_list%20using%20btree%28med_id%29%0A%3B%0A%0A---------------End%20DDP%20with%20existing%20medication%20claim%20%2F%20No%20Switch------------------------------------------------%0A%0A---------------%20Begin%20Apply%20rule%206%20%26%204%20---------------------------------------------%0Adrop%20table%20if%20exists%20temp_outcome_list%3B%0Acreate%20temp%20table%20temp_outcome_list%20as%0Aselect%20cttm.%2A%2C%20%27t1%27%20as%20outcome_type%0Afrom%20temp_tier1_matches%20cttm%0Aunion%0Aselect%20cttm2.%2A%2C%27t2%27%20as%20outcome_type%0Afrom%20temp_tier2_matches%20cttm2%0Aunion%0Aselect%20tbemdl.%2A%2C%27t3%27%20as%20outcome_type%0Afrom%20temp_hzn_existing_med_found_list%20tbemdl%0A%3B%0Acreate%20index%20%22_I_temp_outcome_list_med_id%22%20on%20temp_outcome_list%20using%20btree%28med_id%2Cmml_claim_date%2Coutcome_type%29%0A%3B%0A%0A---------------Begin%20Rule%206%20---------------------------------------%0A--%20If%20multiple%20ddp%20chosen%20medication%20matched%20to%20same%20claim%20record%2C%20earliest%20DDP%20chosen%20medication%20record%20win%0Adrop%20table%20if%20exists%20temp_outcome_list_rule_6%3B%0Acreate%20temp%20table%20temp_outcome_list_rule_6%20as%0Aselect%20tol.mml_record_id%2C%20min%28tol.med_id%29%20as%20min_med_id%0Afrom%20temp_outcome_list%20tol%0Agroup%20by%20tol.mml_record_id%0A%3B%0Acreate%20index%20%22_I_temp_outcome_list_rule_6_med_id%22%20on%20temp_outcome_list_rule_6%20using%20btree%28min_med_id%29%0A%3B%0A---------------End%20Rule%206%20---------------------------------------%0A%0A---------------Begin%20Rule%204%20---------------------------------------%0A--%20If%20same%20chosen%20medication%20match%20to%20muliple%20claims%2C%20we%20will%20only%20count%20the%20most%20recent%20claim%20and%20alternative%20combination.%0A%0A--%20Get%20latest%20claim%20if%20chosen%20med%20has%20mulitple%20switches%20%0Adrop%20table%20if%20exists%20temp_outcome_list_rule_4_max%3B%0Acreate%20temp%20table%20temp_outcome_list_rule_4_max%20as%0Aselect%20ttm.med_id%2C%20max%28ttm.mml_claim_date%29%20as%20max_mml_claim_date%0Afrom%20temp_outcome_list%20ttm%0Ajoin%20temp_outcome_list_rule_6%20tmdsc%20on%20ttm.med_id%20%20%3D%20tmdsc.min_med_id%0Agroup%20by%20ttm.med_id%0A%3B%0Acreate%20index%20%22_I_temp_outcome_list_rule_4_max_1%22%20on%20temp_outcome_list_rule_4_max%20using%20btree%28med_id%2Cmax_mml_claim_date%29%0A%3B%0A%0Adrop%20table%20if%20exists%20temp_outcome_list_rule_4_max_high_t%3B%0Acreate%20temp%20table%20temp_outcome_list_rule_4_max_high_t%20as%0Aselect%20ttm.med_id%2Ctolr4m.max_mml_claim_date%2C%20min%28ttm.outcome_type%29%20as%20highest_outcome_type%0Afrom%20temp_outcome_list%20ttm%0Ajoin%20temp_outcome_list_rule_4_max%20tolr4m%20on%20ttm.med_id%20%3D%20tolr4m.med_id%20and%20ttm.mml_claim_date%20%3D%20tolr4m.max_mml_claim_date%0Agroup%20by%20ttm.med_id%2Ctolr4m.max_mml_claim_date%0A%3B%0Acreate%20index%20%22_I_temp_outcome_list_rule_4_max_high_t_1%22%20on%20temp_outcome_list_rule_4_max_high_t%20using%20btree%28med_id%2Cmax_mml_claim_date%2Chighest_outcome_type%29%0A%3B%0A%0Adrop%20table%20if%20exists%20temp_outcome_list_rule_4%3B%0Acreate%20temp%20table%20temp_outcome_list_rule_4%20as%0Aselect%20ttm.med_id%2C%20max%28ttm.mml_record_id%29%20as%20recent_claim_id%0Afrom%20temp_outcome_list%20ttm%0Ajoin%20temp_outcome_list_rule_4_max_high_t%20tolr4mh%20on%20ttm.med_id%20%3D%20tolr4mh.med_id%20and%20ttm.mml_claim_date%20%3D%20tolr4mh.max_mml_claim_date%20and%20ttm.outcome_type%20%3D%20tolr4mh.highest_outcome_type%0Agroup%20by%20ttm.med_id%0A%3B%0A%0Adrop%20table%20if%20exists%20temp_outcome_report_list%3B%0Acreate%20temp%20table%20temp_outcome_report_list%20as%0Aselect%20tt1.%2A%2Crow_number%28%29%20over%20%28partition%20by%20tt1.med_id%2C%20tt1.mml_claim_date%20order%20by%20tt1.outcome_type%2Ctt1.alt_order%29%20as%20most_savings_order%20--%20list%20of%20switches%20that%20assoicate%20with%20multiple%20alternative%20and%20mulitple%20switches%20for%20same%20existing%20med%0Afrom%20temp_outcome_list%20tt1%0Ajoin%20temp_outcome_list_rule_4%20ttmdm%20on%20tt1.med_id%20%3D%20ttmdm.med_id%20and%20tt1.mml_record_id%20%3D%20ttmdm.recent_claim_id%0A%3B%0A---------------End%20Rule%204%20---------------------------------------%0A%0Acreate%20index%20%22_I_temp_outcome_report_list_med_id%22%20on%20temp_outcome_report_list%20using%20btree%28med_id%2Coutcome_type%29%0A%3B%0Acreate%20index%20%22_I_temp_outcome_report_list_med_id_most_savings_order%22%20on%20temp_outcome_report_list%20using%20btree%28med_id%2Cmost_savings_order%29%0A%3B%0A%0A--%20Cleanup%20temp%20table%0Adrop%20table%20if%20exists%20temp_outcome_list_rule_6%3B%0Adrop%20table%20if%20exists%20temp_outcome_list_rule_4_max%3B%0Adrop%20table%20if%20exists%20temp_outcome_list_rule_4_max_high_t%3B%0Adrop%20table%20if%20exists%20temp_outcome_list_rule_4%3B%0A---------------%20End%20Apply%20rule%206%20%26%204%20------------------------------------------------%0A%0A---------------Begin%20Create%20DDP%20Raw%20data%20------------------------------------%0Adrop%20table%20if%20exists%20temp_ddp_report%3B%0Acreate%20temp%20table%20temp_ddp_report%20as%0Aselect%20distinct%20org.ehr_organization_id%0A%2Cbt.id%20as%20transaction_id%0A%2Cpm.id%20as%20med_id%0A%2Cbt.inserted_at%0A%2Cphy.last_name%20%7C%7C%20%27%2C%20%27%20%7C%7C%20phy.first_name%20as%20prescriber_name%0A%2Cphy.npi%20as%20prescriber_npi%0A%2Csc.ehr_name%20as%20org_name%0A%2Cpl.name%20as%20requested_existing_medication%0A%2Cpm.quantity%0A%2Cpm.days_supply%0A%2Cpharm.npi%20as%20pharmacy_npi%0A%2Ccase%0A%09when%20pl.brand%20%3D%20true%20then%20%27Y%27%0A%09when%20pl.brand%20%3D%20false%20then%20%27N%27%20%0Aend%20as%20requested_existing_brand%0A%2Ccase%0A%09when%20pm.prior_auth_needed%20%3D%20true%20then%20%27Y%27%0A%09when%20pm.prior_auth_needed%20%3D%20false%20then%20%27N%27%0Aend%20as%20requested_existing_pa%0A%2Cpm.ndc%20as%20requested_existing_ndc%0A%2Cpm.patient_pay_amount%20as%20requested_existing_patient_pay_amount%0A%2Cpm.total_cost%20as%20requested_existing_total_cost%0A%2Cpl.specific_product_id%20as%20requested_existing_spid%0A%2C%20case%0A%09when%20pl.maintenance%20%3D%20true%20then%20%27M%27%09--Maintenance%0A%09when%20pl.maintenance%20%3D%20false%20and%20pl.periodic%20%3D%20true%20then%20%27P%27%09--Periodic%0A%09when%20pl.maintenance%20%3D%20false%20and%20pl.periodic%20%3D%20false%20then%20%27A%27%09--Acute%0Aend%20as%20requested_existing_med_type%0A%2Cpl.gpi%20as%20requested_existing_gpi%0A%2Cpe.concept_name%20as%20requested_existing_concept_name%0A%2Cpat.emr_patient_id%0A%2Cic.bin%20as%20bin%0A%2Cic.pcn%20as%20pcn%0A--ALT%201%0A%2Calt1.alt_display_name%20as%20alt1_med%0A%2Calt1.alt_generic_name%20as%20alt1_generic_name%0A%2Calt1.alt_days_supply%20as%20alt1_days_supply%0A%2Calt1.alt_quantity%20as%20alt1_medication_quantity%0A%2Calt1.alt_brand%20as%20alt1_brand%0A%2Calt1.alt_prior_auth_needed%20%20as%20alt1_pa%0A%2Calt1.alt_ndc%20as%20alt1_ndc%0A%2Calt1.alt_specific_product_id%20as%20alt1_spid%0A%2Calt1.alt_gpi_14%20as%20alt1_gpi%0A%2Calt1.alt_concept_name%20as%20alt1_concept%0A%2Calt1.alt_patient_pay_amount%20as%20alt1_patient_pay_amount%0A%2Calt1.alt_total_cost%20as%20alt1_total_cost%0A--ALT%202%0A%2Calt2.alt_display_name%20as%20alt2_med%0A%2Calt2.alt_generic_name%20as%20alt2_generic_name%0A%2Calt2.alt_days_supply%20as%20alt2_days_supply%0A%2Calt2.alt_quantity%20as%20alt2_medication_quantity%0A%2Calt2.alt_brand%20as%20alt2_brand%0A%2Calt2.alt_prior_auth_needed%20%20as%20alt2_pa%0A%2Calt2.alt_ndc%20as%20alt2_ndc%0A%2Calt2.alt_specific_product_id%20as%20alt2_spid%0A%2Calt2.alt_gpi_14%20as%20alt2_gpi%0A%2Calt2.alt_concept_name%20as%20alt2_concept%0A%2Calt2.alt_patient_pay_amount%20as%20alt2_patient_pay_amount%0A%2Calt2.alt_total_cost%20as%20alt2_total_cost%0A--ALT%203%0A%2Calt3.alt_display_name%20as%20alt3_med%0A%2Calt3.alt_generic_name%20as%20alt3_generic_name%0A%2Calt3.alt_days_supply%20as%20alt3_days_supply%0A%2Calt3.alt_quantity%20as%20alt3_medication_quantity%0A%2Calt3.alt_brand%20as%20alt3_brand%0A%2Calt3.alt_prior_auth_needed%20as%20alt3_pa%0A%2Calt3.alt_ndc%20as%20alt3_ndc%0A%2Calt3.alt_specific_product_id%20as%20alt3_spid%0A%2Calt3.alt_gpi_14%20as%20alt3_gpi%0A%2Calt3.alt_concept_name%20as%20alt3_concept%0A%2Calt3.alt_patient_pay_amount%20as%20alt3_patient_pay_amount%0A%2Calt3.alt_total_cost%20as%20alt3_total_cost%0A%2Cett.outcome_type%0A%2Cpe.super_concept%20as%20requested_existing_super_concept%0A%2Cip.line_of_business%0Afrom%20public.beacon_transactions%20bt%0Ajoin%20public.patients%20pat%20on%20bt.patient_id%20%3D%20pat.id%0Ajoin%20public.priced_medications%20pm%20on%20bt.id%20%3D%20pm.beacon_transaction_id%20and%20pm.chosen_med%20%3D%20true%0Ajoin%20public.providers%20phy%20on%20bt.provider_id%20%3D%20phy.id%0Ajoin%20public.insurance_policies%20ip%20on%20pat.id%20%3D%20ip.patient_id%0Ajoin%20public.insurance_companies%09ic%20on%20ip.insurance_company_id%20%3D%20ic.id%0Ajoin%20pbm_logs%20pls%20on%20bt.request_id%20%3D%20pls.request_id%20and%20pls.is_final%20%3D%20true%20%0Ajoin%20temp_outcome_report_list%20ett%20on%20pm.id%20%3D%20ett.med_id%20and%20ett.most_savings_order%20%3D%201%20--Matched%20results%20existing_med_found%20%2B%20Tier%201%20%2B%20Tier%202%0Ajoin%20payers%20pay%20on%20ic.payer_id%20%3D%20pay.id%0Ajoin%20organizations%20org%20on%20phy.organization_id%20%3D%20org.id%0Ajoin%20product_lookup%20pl%20on%20pm.ndc%20%3D%20pl.ndc%0Aleft%20join%20product_equivalencies%20pe%20on%20pl.specific_product_id%20%3D%20pe.specific_product_id%20%0Aleft%20join%20pharmacies%20pharm%20on%20pm.pharmacy_id%20%3D%20pharm.id%0Aleft%20join%20surescripts_ddps%20ssddp%20on%20bt.id%20%3D%20ssddp.beacon_transaction_id%0Aleft%20join%20surescripts_crosswalks%20sc%20on%20sc.account_id%20%3D%20ssddp.sender_tertiary_identification%0Aleft%20join%20%28select%20alter1.med_id%2Calter1.alt_display_name%2Calter1.alt_ndc%2Calter1.alt_days_supply%2Calter1.alt_quantity%2Calter1.alt_id%2Calter1.alt_brand%2Calter1.alt_prior_auth_needed%2Calter1.alt_specific_product_id%2Calter1.alt_order%2Calter1.alt_gpi_14%2Calter1.alt_generic_name%2Calter1.alt_concept_name%2Calter1.alt_patient_pay_amount%2Calter1.alt_total_cost%0Afrom%20temp_altermedlist%20alter1%0Awhere%20alter1.alt_order%20%3D%201%29%20alt1%20on%20pm.id%20%3D%20alt1.med_id%0Aleft%20join%20%28select%20alter2.med_id%2Calter2.alt_display_name%2Calter2.alt_ndc%2Calter2.alt_days_supply%2Calter2.alt_quantity%2Calter2.alt_id%2Calter2.alt_brand%2Calter2.alt_prior_auth_needed%2Calter2.alt_specific_product_id%2Calter2.alt_order%2Calter2.alt_gpi_14%2Calter2.alt_generic_name%2Calter2.alt_concept_name%2Calter2.alt_patient_pay_amount%2Calter2.alt_total_cost%0Afrom%20temp_altermedlist%20alter2%0Awhere%20alter2.alt_order%20%3D%202%29%20alt2%20on%20pm.id%20%3D%20alt2.med_id%0Aleft%20join%20%28select%20alter3.med_id%2Calter3.alt_display_name%2Calter3.alt_ndc%2Calter3.alt_days_supply%2Calter3.alt_quantity%2Calter3.alt_id%2Calter3.alt_brand%2Calter3.alt_prior_auth_needed%2Calter3.alt_specific_product_id%2Calter3.alt_order%2Calter3.alt_gpi_14%2Calter3.alt_generic_name%2Calter3.alt_concept_name%2Calter3.alt_patient_pay_amount%2Calter3.alt_total_cost%0Afrom%20temp_altermedlist%20alter3%0Awhere%20alter3.alt_order%20%3D%203%29%20alt3%20on%20pm.id%20%3D%20alt3.med_id%0Awhere%20lower%28pay.%22name%22%29%20%3D%20%27horizon%27%20%0A%09and%20lower%28bt.transaction_type%29%20%3D%20%27c%27%0A%09and%20org.ehr_organization_id%20not%20in%20%28%271%27%29%0A%09and%20bt.pbm_called%20%3D%20true%20--%20called%20PBM%20for%20info%0A%09and%20bt.inserted_at%3A%3Adate%20between%20cast%28date_trunc%28%27month%27%2C%20current_date%20-%20%274%20month%27%3A%3Ainterval%29%20as%20date%29%20and%20cast%28date_trunc%28%27month%27%2C%20current_date%29-%20%271%20second%27%3A%3Ainterval%20as%20date%29%0A%3B%0Acreate%20index%20%22_I_temp_ddp_report_1%22%20on%20temp_ddp_report%20using%20btree%28med_id%2Coutcome_type%29%0A%3B%0A%0A---------------End%20Create%20DDP%20Raw%20data%20------------------------------------%0A%0A%0A---------------Begin%20Generate%20Output%20Report%20-----------------------------------%0A--drop%20table%20if%20exists%20rpt_hzn_ddp_claim_gpi_switches%3B%0A--create%20table%20rpt_hzn_ddp_claim_gpi_switches%20as%0Ainsert%20into%20rpt_hzn_ddp_claim_gpi_switches%20%0Aselect%20now%28%29%20as%20%22ReportDate%22%0A%09%2Ctdr.transaction_id%20as%20%22GeminiTransactionID%22%0A%09%2Ctdr.bin%20as%20%22BIN%22%0A%09%2Ctdr.pcn%20as%20%22PCN%22%0A%09%2Ctdr.inserted_at%20as%20%22TransactionDate%22%0A%09%2Ctdr.prescriber_name%20as%20%22PrescriberName%22%0A%09%2Ctdr.prescriber_npi%20as%20%22PrescriberNPI%22%0A%09%2Ctdr.requested_existing_medication%20as%20%22ExistingDrug%22%0A%09%2Ctdr.quantity%20as%20%22ExistingDrugQuantity%22%0A%09%2Ctdr.days_supply%20as%20%22ExistingDrugDaysSupply%22%0A%09%2Ctdr.requested_existing_brand%20as%20%22ExistingDrugBrand%22%0A%09%2Ctdr.requested_existing_ndc%3A%3Aint8%20as%20%22ExistingDrugNDC%22%0A%09%2Ctdr.requested_existing_pa%20as%20%22ExistingDrugPA%22%0A%09%2Ctdr.requested_existing_spid%20as%20%22ExistingDrugSPID%22%0A%09%2Ctdr.requested_existing_concept_name%20as%20%22ExistingDrugConceptName%22%0A%09%2Ctdr.requested_existing_med_type%20as%20%22ExistingDrugMaintenancePeriodic%22%0A%09%2Ct1.alt_med%20as%20%22AltDrug%22%0A%09%2Ct1.alt_brand%20as%20%22AltDrugBrand%22%0A%09%2Ct1.alt_ndc%3A%3Aint8%20as%20%22AltDrugNDC%22%0A%09%2Ct1.alt_pa%20as%20%22AltDrugPA%22%0A%09%2Ct1.alt_spid%20as%20%22AltDrugSPID%22%0A%09%2Ct1.alt_concept%20as%20%22AltDrugConceptName%22%0A%09%2Ct1.alt_quantity%20as%20%22AltDrugQuantity%22%0A%09%2Ct1.alt_days_supply%20as%20%22AltDrugDaysSupply%22%0A%09%2Ct1.mml_med%20as%20%22ClaimDrug%22%0A%09%2Ct1.mml_med_brand%20as%20%22ClaimDrugBrand%22%0A%09%2Ct1.mml_claim_date%20as%20%22ClaimDate%22%0A%09%2Ct1.mml_ndc%3A%3Aint8%20as%20%22ClaimDrugNDC%22%0A%09%2Ct1.mml_spid%20as%20%22ClaimDrugSPID%22%0A%09%2Ct1.mml_concept_name%20as%20%22ClaimDrugConceptName%22%0A%09%2Ct1.mml_quantity%20as%20%22ClaimDrugQuantity%22%0A%09%2Ct1.mml_days_supply%20as%20%22ClaimDrugDaysSupply%22%0A%09%2Ct1.mml_med_type%20as%20%22ClaimDrugMaintenancePeriodic%22%0A%09%2Ct1.alt_annual_patient_savings%20as%20%22AnnualPatientSavings%22%0A%09%2Ct1.alt_annual_total_savings%20as%20%22AnnualTotalSavings%22%09%0A%09%2Ct1.switch_change_month%3A%3Aint8%20as%20%22SwitchChangeMonth%22%0A%09%2Ctdr.transaction_id%3A%3Atext%20%7C%7C%20tdr.requested_existing_ndc%3A%3Aint8%20as%20%22uid%22%0A%09%2C%27t1%27%20as%20%22sc%22%0A%09%2Ct1.change_type%20as%20%22ChangeType%22%0A%09%2Ctdr.org_name%20as%20%22org%22%0A%09%2C%27DDP%27%20as%20%22ProductLine%22%0A%09--ALT%201%0A%09%2Ctdr.alt1_med%20as%20%22Alt1Drug%22%0A%09%2Ctdr.alt1_generic_name%20as%20%22Alt1DrugGenericName%22%0A%09%2Ctdr.alt1_brand%20as%20%22Alt1DrugBrand%22%0A%09%2Ctdr.alt1_ndc%3A%3Aint8%20as%20%22Alt1DrugNDC%22%0A%09%2Ctdr.alt1_pa%20as%20%22Alt1DrugPA%22%0A%09%2Ctdr.alt1_spid%20as%20%22Alt1DrugSPID%22%0A%09%2Ctdr.alt1_concept%20as%20%22Alt1DrugConceptName%22%0A%09%2Ctdr.alt1_medication_quantity%20as%20%22Alt1DrugQuantity%22%0A%09%2Ctdr.alt1_days_supply%20as%20%22Alt1DrugDaysSupply%22%0A%09--ALT%202%0A%09%2Ctdr.alt2_med%20as%20%22Alt2Drug%22%0A%09%2Ctdr.alt2_generic_name%20as%20%22Alt2DrugGenericName%22%0A%09%2Ctdr.alt2_brand%20as%20%22Alt2DrugBrand%22%0A%09%2Ctdr.alt2_ndc%3A%3Aint8%20as%20%22Alt2DrugNDC%22%0A%09%2Ctdr.alt2_pa%20as%20%22Alt2DrugPA%22%0A%09%2Ctdr.alt2_spid%20as%20%22Alt2DrugSPID%22%0A%09%2Ctdr.alt2_concept%20as%20%22Alt2DrugConceptName%22%0A%09%2Ctdr.alt2_medication_quantity%20as%20%22Alt2DrugQuantity%22%0A%09%2Ctdr.alt2_days_supply%20as%20%22Alt2DrugDaysSupply%22%0A%09--ALT%203%0A%09%2Ctdr.alt3_med%20as%20%22Alt3Drug%22%0A%09%2Ctdr.alt3_generic_name%20as%20%22Alt3DrugGenericName%22%0A%09%2Ctdr.alt3_brand%20as%20%22Alt3DrugBrand%22%0A%09%2Ctdr.alt3_ndc%3A%3Aint8%20as%20%22Alt3DrugNDC%22%0A%09%2Ctdr.alt3_pa%20as%20%22Alt3DrugPA%22%0A%09%2Ctdr.alt3_spid%20as%20%22Alt3DrugSPID%22%0A%09%2Ctdr.alt3_concept%20as%20%22Alt3DrugConceptName%22%0A%09%2Ctdr.alt3_medication_quantity%20as%20%22Alt3DrugQuantity%22%0A%09%2Ctdr.alt3_days_supply%20as%20%22Alt3DrugDaysSupply%22%0A%09%2Ctdr.med_id%20as%20%22ExistingMedInternalID%22%0A%09%2Ctdr.requested_existing_gpi%0A%09%2Ct1.mml_gpi%0A%09%2Ctdr.alt1_gpi%0A%09%2Ctdr.alt2_gpi%0A%09%2Ctdr.alt3_gpi%0A%09%2Ctdr.requested_existing_patient_pay_amount%0A%09%2Ctdr.requested_existing_total_cost%0A%09%2Ct1.mml_patient_cost%0A%09%2Ct1.mml_total_cost%0A%09%2Ctdr.alt1_patient_pay_amount%0A%09%2Ctdr.alt1_total_cost%0A%09%2Ctdr.alt2_patient_pay_amount%0A%09%2Ctdr.alt2_total_cost%0A%09%2Ctdr.alt3_patient_pay_amount%0A%09%2Ctdr.alt3_total_cost%0A%09%2Ct1.carrier_id%0A%09%2Ct1.account_id%0A%09%2Ct1.group_id%0A%09%2Ct1.alt_patient_savings_v1%0A%09%2Ct1.alt_total_savings_v1%0A%09%2C0.00%20as%20%22AnnualPatientSavings_SD%22%0A%09%2C0.00%20as%20%22AnnualTotalSavings_SD%22%0A%09%2C%27%27%20as%20flag_ex%0A%09%2Ct1.alt_annual_patient_savings%20as%20%22AdjustedPatientSavings%22%0A%09%2Ct1.alt_annual_total_savings%20as%20%22AdjustedTotalSavings%22%0A%09%2Ctdr.requested_existing_super_concept%0A%09%2Ct1.mml_med_super_concept%0A%09%2Ctdr.line_of_business%0Afrom%20temp_ddp_report%20tdr%0Ajoin%20temp_outcome_report_list%20t1%20on%20tdr.med_id%20%3D%20t1.med_id%20and%20t1.most_savings_order%20%3D%201%0Awhere%20tdr.outcome_type%20%3D%20%27t1%27%0AUNION%20ALL%0Aselect%20now%28%29%20as%20%22ReportDate%22%0A%09%2Ctdr.transaction_id%20as%20%22GeminiTransactionID%22%0A%09%2Ctdr.bin%20as%20%22BIN%22%0A%09%2Ctdr.pcn%20as%20%22PCN%22%0A%09%2Ctdr.inserted_at%20as%20%22TransactionDate%22%0A%09%2Ctdr.prescriber_name%20as%20%22PrescriberName%22%0A%09%2Ctdr.prescriber_npi%20as%20%22PrescriberNPI%22%0A%09%2Ctdr.requested_existing_medication%20as%20%22ExistingDrug%22%0A%09%2Ctdr.quantity%20as%20%22ExistingDrugQuantity%22%0A%09%2Ctdr.days_supply%20as%20%22ExistingDrugDaysSupply%22%0A%09%2Ctdr.requested_existing_brand%20as%20%22ExistingDrugBrand%22%0A%09%2Ctdr.requested_existing_ndc%3A%3Aint8%20as%20%22ExistingDrugNDC%22%0A%09%2Ctdr.requested_existing_pa%20as%20%22ExistingDrugPA%22%0A%09%2Ctdr.requested_existing_spid%20as%20%22ExistingDrugSPID%22%0A%09%2Ctdr.requested_existing_concept_name%20as%20%22ExistingDrugConceptName%22%0A%09%2Ctdr.requested_existing_med_type%20as%20%22ExistingDrugMaintenancePeriodic%22%0A%09%2Ct2.alt_med%20as%20%22AltDrug%22%0A%09%2Ct2.alt_brand%20as%20%22AltDrugBrand%22%0A%09%2Ct2.alt_ndc%3A%3Aint8%20as%20%22AltDrugNDC%22%0A%09%2Ct2.alt_pa%20as%20%22AltDrugPA%22%0A%09%2C0%20as%20%22AltDrugSPID%22%0A%09%2Ct2.alt_concept%20as%20%22AltDrugConceptName%22%0A%09%2Ct2.alt_quantity%20as%20%22AltDrugQuantity%22%0A%09%2Ct2.alt_days_supply%20as%20%22AltDrugDaysSupply%22%0A%09%2Ct2.mml_med%20as%20%22ClaimDrug%22%0A%09%2Ct2.mml_med_brand%20as%20%22ClaimDrugBrand%22%0A%09%2Ct2.mml_claim_date%20as%20%22ClaimDate%22%0A%09%2Ct2.mml_ndc%3A%3Aint8%20as%20%22ClaimDrugNDC%22%0A%09%2Ct2.mml_spid%20as%20%22ClaimDrugSPID%22%0A%09%2Ct2.mml_concept_name%20as%20%22ClaimDrugConceptName%22%0A%09%2Ct2.mml_quantity%20as%20%22ClaimDrugQuantity%22%0A%09%2Ct2.mml_days_supply%20as%20%22ClaimDrugDaysSupply%22%0A%09%2Ct2.mml_med_type%20as%20%22ClaimDrugMaintenancePeriodic%22%0A%09%2Ct2.alt_annual_patient_savings%20as%20%22AnnualPatientSavings%22%0A%09%2Ct2.alt_annual_total_savings%20as%20%22AnnualTotalSavings%22%09%0A%09%2Ct2.switch_change_month%3A%3Aint8%20as%20%22SwitchChangeMonth%22%0A%09%2Ctdr.transaction_id%3A%3Atext%20%20%7C%7C%20tdr.requested_existing_ndc%3A%3Aint8%20as%20%22uid%22%0A%09%2C%27t2%27%20as%20%22sc%22%0A%09%2Ct2.change_type%20as%20%22ChangeType%22%0A%09%2Ctdr.org_name%20as%20%22org%22%0A%09%2C%27DDP%27%20as%20%22ProductLine%22%0A%09--ALT%201%0A%09%2Ctdr.alt1_med%20as%20%22Alt1Drug%22%0A%09%2Ctdr.alt1_generic_name%20as%20%22Alt1DrugGenericName%22%0A%09%2Ctdr.alt1_brand%20as%20%22Alt1DrugBrand%22%0A%09%2Ctdr.alt1_ndc%3A%3Aint8%20as%20%22Alt1DrugNDC%22%0A%09%2Ctdr.alt1_pa%20as%20%22Alt1DrugPA%22%0A%09%2Ctdr.alt1_spid%20as%20%22Alt1DrugSPID%22%0A%09%2Ctdr.alt1_concept%20as%20%22Alt1DrugConceptName%22%0A%09%2Ctdr.alt1_medication_quantity%20as%20%22Alt1DrugQuantity%22%0A%09%2Ctdr.alt1_days_supply%20as%20%22Alt1DrugDaysSupply%22%0A%09--ALT%202%0A%09%2Ctdr.alt2_med%20as%20%22Alt2Drug%22%0A%09%2Ctdr.alt2_generic_name%20as%20%22Alt2DrugGenericName%22%0A%09%2Ctdr.alt2_brand%20as%20%22Alt2DrugBrand%22%0A%09%2Ctdr.alt2_ndc%3A%3Aint8%20as%20%22Alt2DrugNDC%22%0A%09%2Ctdr.alt2_pa%20as%20%22Alt2DrugPA%22%0A%09%2Ctdr.alt2_spid%20as%20%22Alt2DrugSPID%22%0A%09%2Ctdr.alt2_concept%20as%20%22Alt2DrugConceptName%22%0A%09%2Ctdr.alt2_medication_quantity%20as%20%22Alt2DrugQuantity%22%0A%09%2Ctdr.alt2_days_supply%20as%20%22Alt2DrugDaysSupply%22%0A%09--ALT%203%0A%09%2Ctdr.alt3_med%20as%20%22Alt3Drug%22%0A%09%2Ctdr.alt3_generic_name%20as%20%22Alt3DrugGenericName%22%0A%09%2Ctdr.alt3_brand%20as%20%22Alt3DrugBrand%22%0A%09%2Ctdr.alt3_ndc%3A%3Aint8%20as%20%22Alt3DrugNDC%22%0A%09%2Ctdr.alt3_pa%20as%20%22Alt3DrugPA%22%0A%09%2Ctdr.alt3_spid%20as%20%22Alt3DrugSPID%22%0A%09%2Ctdr.alt3_concept%20as%20%22Alt3DrugConceptName%22%0A%09%2Ctdr.alt3_medication_quantity%20as%20%22Alt3DrugQuantity%22%0A%09%2Ctdr.alt3_days_supply%20as%20%22Alt3DrugDaysSupply%22%0A%09%2Ctdr.med_id%20as%20%22ExistingMedInternalID%22%0A%09%2Ctdr.requested_existing_gpi%0A%09%2Ct2.mml_gpi%0A%09%2Ctdr.alt1_gpi%0A%09%2Ctdr.alt2_gpi%0A%09%2Ctdr.alt3_gpi%0A%09%2Ctdr.requested_existing_patient_pay_amount%0A%09%2Ctdr.requested_existing_total_cost%0A%09%2Ct2.mml_patient_cost%0A%09%2Ct2.mml_total_cost%0A%09%2Ctdr.alt1_patient_pay_amount%0A%09%2Ctdr.alt1_total_cost%0A%09%2Ctdr.alt2_patient_pay_amount%0A%09%2Ctdr.alt2_total_cost%0A%09%2Ctdr.alt3_patient_pay_amount%0A%09%2Ctdr.alt3_total_cost%0A%09%2Ct2.carrier_id%0A%09%2Ct2.account_id%0A%09%2Ct2.group_id%0A%09%2Ct2.alt_patient_savings_v1%0A%09%2Ct2.alt_total_savings_v1%0A%09%2C0.00%20as%20%22AnnualPatientSavings_SD%22%0A%09%2C0.00%20as%20%22AnnualTotalSavings_SD%22%0A%09%2C%27%27%20as%20flag_ex%0A%09%2Ct2.alt_annual_patient_savings%20%2A%200.75%20as%20%22AdjustedPatientSavings%22%0A%09%2Ct2.alt_annual_total_savings%20%2A%200.75%20as%20%22AdjustedTotalSavings%22%0A%09%2Ctdr.requested_existing_super_concept%0A%09%2Ct2.mml_med_super_concept%0A%09%2Ctdr.line_of_business%0Afrom%20temp_ddp_report%20tdr%0Ajoin%20temp_outcome_report_list%20t2%20on%20tdr.med_id%20%3D%20t2.med_id%20and%20t2.most_savings_order%20%3D%201%0Awhere%20tdr.outcome_type%20%3D%20%27t2%27%0AUNION%20ALL%20%0Aselect%20now%28%29%20as%20%22ReportDate%22%0A%09%2Ctdr.transaction_id%20as%20%22GeminiTransactionID%22%0A%09%2Ctdr.bin%20as%20%22BIN%22%0A%09%2Ctdr.pcn%20as%20%22PCN%22%0A%09%2Ctdr.inserted_at%20as%20%22TransactionDate%22%0A%09%2Ctdr.prescriber_name%20as%20%22PrescriberName%22%0A%09%2Ctdr.prescriber_npi%20as%20%22PrescriberNPI%22%0A%09%2Ctdr.requested_existing_medication%20as%20%22ExistingDrug%22%0A%09%2Ctdr.quantity%20as%20%22ExistingDrugQuantity%22%0A%09%2Ctdr.days_supply%20as%20%22ExistingDrugDaysSupply%22%0A%09%2Ctdr.requested_existing_brand%20as%20%22ExistingDrugBrand%22%0A%09%2Ctdr.requested_existing_ndc%3A%3Aint8%20as%20%22ExistingDrugNDC%22%0A%09%2Ctdr.requested_existing_pa%20as%20%22ExistingDrugPA%22%0A%09%2Ctdr.requested_existing_spid%20as%20%22ExistingDrugSPID%22%0A%09%2Ctdr.requested_existing_concept_name%20as%20%22ExistingDrugConceptName%22%0A%09%2Ctdr.requested_existing_med_type%20as%20%22ExistingDrugMaintenancePeriodic%22%0A%09%2Cnull%20as%20%22AltDrug%22%0A%09%2Cnull%20as%20%22AltDrugBrand%22%0A%09%2Cnull%20as%20%22AltDrugNDC%22%0A%09%2Cnull%20as%20%22AltDrugPA%22%0A%09%2Cnull%20as%20%22AltDrugSPID%22%0A%09%2Cnull%20as%20%22AltDrugConceptName%22%0A%09%2Cnull%20as%20%22AltDrugQuantity%22%0A%09%2Cnull%20as%20%22AltDrugDaysSupply%22%0A%09%2Cef.mml_med%20as%20%22ClaimDrug%22%0A%09%2Cef.mml_med_brand%20as%20%22ClaimDrugBrand%22%0A%09%2Cef.mml_claim_date%20as%20%22ClaimDate%22%0A%09%2Cef.mml_ndc%3A%3Aint8%20as%20%22ClaimDrugNDC%22%0A%09%2Cef.mml_spid%20as%20%22ClaimDrugSPID%22%0A%09%2Cef.mml_concept_name%20as%20%22ClaimDrugConceptName%22%0A%09%2Cef.mml_quantity%20as%20%22ClaimDrugQuantity%22%0A%09%2Cef.mml_days_supply%20as%20%22ClaimDrugDaysSupply%22%0A%09%2Cef.mml_med_type%20as%20%22ClaimDrugMaintenancePeriodic%22%0A%09%2Cnull%20as%20%22AnnualPatientSavings%22%20--ef.alt_annual_patient_savings%20as%20%22AnnualPatientSavings%22%0A%09%2Cnull%20as%20%22AnnualTotalSavings%22%20--ef.alt_annual_total_savings%20as%20%22AnnualTotalSavings%22%0A%09%2Cef.switch_change_month%3A%3Aint8%20as%20%22SwitchChangeMonth%22%0A%09%2Ctdr.transaction_id%3A%3Atext%20%20%7C%7C%20tdr.requested_existing_ndc%3A%3Aint8%20as%20%22uid%22%0A%09%2C%27NoSwitch%27%20as%20%22sc%22%0A%09%2Cef.change_type%20as%20%22ChangeType%22%0A%09%2Ctdr.org_name%20as%20%22org%22%0A%09%2C%27DDP%27%20as%20%22ProductLine%22%0A%09--ALT%201%0A%09%2Ctdr.alt1_med%20as%20%22Alt1Drug%22%0A%09%2Ctdr.alt1_generic_name%20as%20%22Alt1DrugGenericName%22%0A%09%2Ctdr.alt1_brand%20as%20%22Alt1DrugBrand%22%0A%09%2Ctdr.alt1_ndc%3A%3Aint8%20as%20%22Alt1DrugNDC%22%0A%09%2Ctdr.alt1_pa%20as%20%22Alt1DrugPA%22%0A%09%2Ctdr.alt1_spid%20as%20%22Alt1DrugSPID%22%0A%09%2Ctdr.alt1_concept%20as%20%22Alt1DrugConceptName%22%0A%09%2Ctdr.alt1_medication_quantity%20as%20%22Alt1DrugQuantity%22%0A%09%2Ctdr.alt1_days_supply%20as%20%22Alt1DrugDaysSupply%22%0A%09--ALT%202%0A%09%2Ctdr.alt2_med%20as%20%22Alt2Drug%22%0A%09%2Ctdr.alt2_generic_name%20as%20%22Alt2DrugGenericName%22%0A%09%2Ctdr.alt2_brand%20as%20%22Alt2DrugBrand%22%0A%09%2Ctdr.alt2_ndc%3A%3Aint8%20as%20%22Alt2DrugNDC%22%0A%09%2Ctdr.alt2_pa%20as%20%22Alt2DrugPA%22%0A%09%2Ctdr.alt2_spid%20as%20%22Alt2DrugSPID%22%0A%09%2Ctdr.alt2_concept%20as%20%22Alt2DrugConceptName%22%0A%09%2Ctdr.alt2_medication_quantity%20as%20%22Alt2DrugQuantity%22%0A%09%2Ctdr.alt2_days_supply%20as%20%22Alt2DrugDaysSupply%22%0A%09--ALT%203%0A%09%2Ctdr.alt3_med%20as%20%22Alt3Drug%22%0A%09%2Ctdr.alt3_generic_name%20as%20%22Alt3DrugGenericName%22%0A%09%2Ctdr.alt3_brand%20as%20%22Alt3DrugBrand%22%0A%09%2Ctdr.alt3_ndc%3A%3Aint8%20as%20%22Alt3DrugNDC%22%0A%09%2Ctdr.alt3_pa%20as%20%22Alt3DrugPA%22%0A%09%2Ctdr.alt3_spid%20as%20%22Alt3DrugSPID%22%0A%09%2Ctdr.alt3_concept%20as%20%22Alt3DrugConceptName%22%0A%09%2Ctdr.alt3_medication_quantity%20as%20%22Alt3DrugQuantity%22%0A%09%2Ctdr.alt3_days_supply%20as%20%22Alt3DrugDaysSupply%22%0A%09%2Ctdr.med_id%20as%20%22ExistingMedInternalID%22%0A%09%2Ctdr.requested_existing_gpi%0A%09%2Cef.mml_gpi%0A%09%2Ctdr.alt1_gpi%0A%09%2Ctdr.alt2_gpi%0A%09%2Ctdr.alt3_gpi%0A%09%2Ctdr.requested_existing_patient_pay_amount%0A%09%2Ctdr.requested_existing_total_cost%0A%09%2Cef.mml_patient_cost%0A%09%2Cef.mml_total_cost%0A%09%2Ctdr.alt1_patient_pay_amount%0A%09%2Ctdr.alt1_total_cost%0A%09%2Ctdr.alt2_patient_pay_amount%0A%09%2Ctdr.alt2_total_cost%0A%09%2Ctdr.alt3_patient_pay_amount%0A%09%2Ctdr.alt3_total_cost%0A%09%2Cef.carrier_id%0A%09%2Cef.account_id%0A%09%2Cef.group_id%0A%09%2Cef.alt_patient_savings_v1%0A%09%2Cef.alt_total_savings_v1%0A%09%2C0.00%20as%20%22AnnualPatientSavings_SD%22%0A%09%2C0.00%20as%20%22AnnualTotalSavings_SD%22%0A%09%2C%27%27%20as%20flag_ex%0A%09%2Cnull%20as%20%22AdjustedPatientSavings%22%0A%09%2Cnull%20as%20%22AdjustedTotalSavings%22%0A%09%2Ctdr.requested_existing_super_concept%0A%09%2Cef.mml_med_super_concept%0A%09%2Ctdr.line_of_business%0Afrom%20temp_ddp_report%20tdr%0Ajoin%20temp_outcome_report_list%20ef%20on%20tdr.med_id%20%3D%20ef.med_id%20and%20ef.most_savings_order%20%3D%201%0Awhere%20tdr.outcome_type%20%3D%20%27t3%27%0A%3B%0A---------------End%20Generate%20Output%20Report%20-----------------------------------%0A%0A---------------%20SET%20STDDEV-----------------------------------%0Adrop%20table%20if%20exists%20temp_std%3B%0Acreate%20temp%20table%20temp_std%20as%0Aselect%20%22ProductLine%22%2C%22org%22%2C%22SwitchChangeMonth%22%2Cstddev_pop%28%22AnnualPatientSavings%22%29%20as%20pat_saving_std%20%2C%20stddev_pop%28%22AnnualTotalSavings%22%29%20as%20total_savings_std%0Afrom%20rpt_hzn_ddp_claim_gpi_switches%0Awhere%20%22sc%22%20in%20%28%27t1%27%2C%27t2%27%29%0Agroup%20by%20%22ProductLine%22%2C%22org%22%2C%22SwitchChangeMonth%22%0A%3B%0A%0A--%20Set%20Stand%20StDevP%20for%20this%20record%0Aupdate%20rpt_hzn_ddp_claim_gpi_switches%20as%20rbdcgs%0Aset%20%22AnnualPatientSavings_SD%22%20%3D%20case%20%0A%09%09%09%09%09%09%09%09%09when%20ts.pat_saving_std%20%3D%200%20then%200%0A%09%09%09%09%09%09%09%09%09else%20%28%22AnnualPatientSavings%22%2Fts.pat_saving_std%29%0A%09%09%09%09%09%09%09%09end%2C%20%0A%09%22AnnualTotalSavings_SD%22%20%3D%20case%20%0A%09%09%09%09%09%09%09%09%09when%20ts.total_savings_std%20%3D%200%20then%200%0A%09%09%09%09%09%09%09%09%09else%20%28%22AnnualTotalSavings%22%2Fts.total_savings_std%29%0A%09%09%09%09%09%09%09%09end%0Afrom%20temp_std%20ts%0Awhere%20rbdcgs.%22ProductLine%22%20%3D%20ts.%22ProductLine%22%20and%20rbdcgs.%22org%22%3D%20ts.%22org%22%20and%20rbdcgs.%22SwitchChangeMonth%22%3D%20ts.%22SwitchChangeMonth%22%20and%20rbdcgs.%22sc%22%20in%20%28%27t1%27%2C%27t2%27%29%0A%3B%0A%0A%0A--%20Set%20FLAG%0Adrop%20table%20if%20exists%20temp_flag%3B%0Acreate%20temp%20table%20temp_flag%20as%0Aselect%20distinct%20x.%22ExistingMedInternalID%22%2C%20concat_ws%28%27%2C%27%2Ca.flag%2Cb.flag%2Cc.flag%2Cd.flag%2Ce.flag%29%20as%20flags%0Afrom%20rpt_hzn_ddp_claim_gpi_switches%20x%0Ajoin%20%28select%20%22ExistingMedInternalID%22%2C%20%27A%27%20as%20flag%0A%09%09from%20rpt_hzn_ddp_claim_gpi_switches%0A%09%09where%20%28%22ExistingDrugNDC%22%20is%20not%20null%20and%20requested_existing_gpi%20is%20null%29%20is%20null%20or%20%28%22Alt1DrugNDC%22%20is%20not%20null%20and%20alt1_gpi%20is%20null%29%20or%20%28%22Alt2DrugNDC%22%20is%20not%20null%20and%20alt2_gpi%20is%20null%29%20or%20%28%22Alt3DrugNDC%22%20is%20not%20null%20and%20alt3_gpi%20is%20null%29%0A%09%09%29%20a%20on%20x.%22ExistingMedInternalID%22%20%3D%20a.%22ExistingMedInternalID%22%0Aleft%20join%20%28select%20%22ExistingMedInternalID%22%2C%20%27B%27%20as%20flag%0A%09%09%09from%20rpt_hzn_ddp_claim_gpi_switches%0A%09%09%09where%20mml_patient_cost%20%3C%200%29%20b%20on%20x.%22ExistingMedInternalID%22%20%3D%20b.%22ExistingMedInternalID%22%0Aleft%20join%20%28select%20%22ExistingMedInternalID%22%2C%20%27C%27%20as%20flag%0A%09%09%09from%20rpt_hzn_ddp_claim_gpi_switches%0A%09%09%09where%20mml_total_cost%20%3C%200%29%20c%20on%20x.%22ExistingMedInternalID%22%20%3D%20c.%22ExistingMedInternalID%22%0Aleft%20join%20%28select%20%22ExistingMedInternalID%22%2C%20%27D%27%20as%20flag%0A%09%09%09from%20rpt_hzn_ddp_claim_gpi_switches%0A%09%09%09where%20%22AnnualPatientSavings_SD%22%20%3E%203%3A%3Aint%29%20d%20on%20x.%22ExistingMedInternalID%22%20%3D%20d.%22ExistingMedInternalID%22%0Aleft%20join%20%28select%20%22ExistingMedInternalID%22%2C%20%27E%27%20as%20flag%0A%09%09%09from%20rpt_hzn_ddp_claim_gpi_switches%0A%09%09%09where%20%22AnnualTotalSavings_SD%22%20%3E%203%3A%3Aint%29%20e%20on%20x.%22ExistingMedInternalID%22%20%3D%20e.%22ExistingMedInternalID%22%0Awhere%20a.%22ExistingMedInternalID%22%20is%20not%20null%20%0A%09or%20b.%22ExistingMedInternalID%22%20is%20not%20null%20%0A%09or%20c.%22ExistingMedInternalID%22%20is%20not%20null%20%0A%09or%20d.%22ExistingMedInternalID%22%20is%20not%20null%20%0A%09or%20e.%22ExistingMedInternalID%22is%20not%20null%20%0A%3B%0A%0Aupdate%20rpt_hzn_ddp_claim_gpi_switches%20as%20rbdcgs%0Aset%20flag_ex%20%3D%20tf.flags%0Afrom%20temp_flag%20tf%0Awhere%20tf.%22ExistingMedInternalID%22%20%3D%20rbdcgs.%22ExistingMedInternalID%22%0A%3B%0A------------End%20Reporting-------------%0ACOMMIT%3B');
